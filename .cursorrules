# Project Rules - 스톡인사이트 (Stock Insight)

## 프로젝트 개요
- **서비스명**: 스톡인사이트 (Stock Insight)
- **목적**: AI 기반 주식 스캐너 서비스
- **기술 스택**: Python 3.11 + FastAPI (백엔드), Next.js 13 + React (프론트엔드), PostgreSQL 16

---

## 1. 백엔드 개발 규칙 (Python/FastAPI)

### 1.1 코드 스타일
- **Python 버전**: Python 3.11 이상
- **코드 포맷팅**: PEP 8 준수
- **타입 힌팅**: 모든 함수에 타입 힌팅 필수
- **Docstring**: Google 스타일 docstring 사용
- **Import 순서**: 표준 라이브러리 → 서드파티 → 로컬 모듈

```python
from typing import List, Optional
from datetime import datetime

import pandas as pd
import numpy as np

from backend.scanner_v2.core.scanner import ScannerV2
from backend.services.market_analyzer import MarketAnalyzer
```

### 1.2 아키텍처 원칙
- **모듈화**: 기능별로 명확히 분리된 모듈 구조
- **의존성 주입**: 외부 의존성은 함수/클래스 인자로 주입
- **단일 책임**: 각 클래스/함수는 하나의 책임만 가짐
- **팩토리 패턴**: Scanner V1/V2는 `scanner_factory.py`를 통해 생성

### 1.3 Scanner 버전 관리
- **버전 선택**: `scanner_settings` 테이블의 `scanner_version` 필드로 관리
- **V1/V2 분리**: 스캔 결과는 버전별로 분리 저장 (`scan_rank` 테이블)
- **팩토리 사용**: 직접 인스턴스화하지 말고 `get_scanner(version='v2')` 사용
- **레짐 분석**: `regime_version` 필드로 v1/v3/v4 선택 (DB 기반)

### 1.4 데이터베이스
- **ORM 사용 금지**: SQLAlchemy 등 ORM 사용하지 않음, 직접 SQL 쿼리 사용
- **트랜잭션**: 데이터 변경 시 반드시 트랜잭션 사용
- **커넥션 관리**: `db_manager.py`의 `get_db_connection()` 사용
- **마이그레이션**: `migrations/` 디렉토리에 SQL 파일로 관리

### 1.5 에러 처리
- **예외 처리**: 구체적인 예외 타입 사용 (ValueError, KeyError 등)
- **로깅**: `logging` 모듈 사용, 레벨 구분 (DEBUG, INFO, WARNING, ERROR)
- **에러 응답**: FastAPI에서 일관된 에러 응답 형식 사용

### 1.6 캐싱
- **OHLCV 캐시**: 메모리 캐시 + 디스크 캐시 조합
- **TTL 관리**: 데이터 특성에 따른 동적 TTL 설정
- **캐시 무효화**: 데이터 업데이트 시 관련 캐시 자동 무효화

### 1.7 API 엔드포인트
- **RESTful 설계**: HTTP 메서드와 상태 코드 적절히 사용
- **응답 형식**: 일관된 JSON 응답 구조
- **인증**: JWT 토큰 기반 인증 (필요한 엔드포인트만)
- **CORS**: 프론트엔드 도메인만 허용

---

## 2. 프론트엔드 개발 규칙 (Next.js/React)

### 2.1 코드 스타일
- **Next.js 버전**: Next.js 13.5.6
- **React 버전**: React 18.2.0
- **JavaScript 사용**: TypeScript 대신 JavaScript 사용 (타입 체크는 `npm run type-check`)
- **컴포넌트**: 함수형 컴포넌트만 사용 (클래스 컴포넌트 금지)
- **Hooks**: React Hooks 적극 활용

### 2.2 파일 구조
```
frontend/
├── pages/          # Next.js 페이지 (라우팅)
├── components/     # 재사용 가능한 컴포넌트
├── contexts/       # React Context (상태 관리)
├── services/       # API 서비스 레이어
├── utils/          # 유틸리티 함수
├── lib/            # 라이브러리 래퍼
└── v2/             # V2 전용 코드 (별도 구조)
```

### 2.3 컴포넌트 규칙
- **컴포넌트 분리**: 재사용 가능한 컴포넌트는 `components/`에 분리
- **Props 검증**: PropTypes 또는 타입 체크 사용
- **에러 바운더리**: 주요 페이지에 에러 바운더리 추가
- **로딩 상태**: 비동기 작업 시 로딩 상태 표시

### 2.4 상태 관리
- **Context API**: 전역 상태는 React Context 사용 (`contexts/AuthContext.js`)
- **로컬 상태**: 컴포넌트 내부 상태는 `useState` 사용
- **서버 상태**: API 데이터는 Context 또는 커스텀 훅으로 관리

### 2.5 API 통신
- **서비스 레이어**: API 호출은 `services/` 디렉토리에 분리
- **에러 처리**: 일관된 에러 핸들링 패턴 사용
- **타임아웃**: API 호출에 타임아웃 설정
- **재시도**: 실패 시 재시도 로직 구현 (필요한 경우)

### 2.6 스타일링
- **Tailwind CSS**: 모든 스타일은 Tailwind CSS 사용
- **반응형**: 모바일/데스크톱 반응형 디자인 필수
- **접근성**: ARIA 속성 추가, 키보드 네비게이션 지원

### 2.7 Scanner 버전 처리
- **버전 확인**: API에서 `scanner_version` 확인 후 조건부 렌더링
- **V1/V2 분리**: V1과 V2는 별도 컴포넌트/페이지로 분리
- **자동 전환**: DB 설정 기반 자동 전환 지원

---

## 3. 데이터베이스 규칙

### 3.1 스키마 관리
- **마이그레이션**: 모든 스키마 변경은 마이그레이션 파일로 관리
- **버전 관리**: 마이그레이션 파일은 날짜 기반 네이밍 (`YYYYMMDD_description.sql`)
- **롤백**: 마이그레이션은 롤백 가능하도록 작성

### 3.2 쿼리 작성
- **파라미터화**: SQL 인젝션 방지를 위해 파라미터화된 쿼리 사용
- **인덱스**: 자주 조회되는 컬럼에 인덱스 추가
- **성능**: EXPLAIN으로 쿼리 성능 확인

### 3.3 테이블 명명
- **스네이크 케이스**: 테이블명과 컬럼명은 스네이크 케이스 사용
- **복수형**: 테이블명은 복수형 사용 (`scan_ranks`, `users`)

### 3.4 주요 테이블
- **scanner_settings**: 스캐너 버전 및 레짐 분석 버전 관리
- **scan_ranks**: 스캔 결과 저장 (V1/V2 분리)
- **popup_notices**: 팝업 공지 관리

---

## 4. API 연동 규칙 (키움증권 API)

### 4.1 API 호출
- **에러 처리**: API 호출 실패 시 적절한 에러 처리 및 재시도
- **Rate Limiting**: API 호출 제한 준수
- **타임아웃**: 모든 API 호출에 타임아웃 설정

### 4.2 인증 정보
- **환경 변수**: API 키는 환경 변수로 관리 (`.env` 파일)
- **암호화**: 민감한 정보는 암호화하여 저장
- **보안**: API 키는 절대 코드에 하드코딩하지 않음

### 4.3 데이터 검증
- **입력 검증**: API 응답 데이터 검증 필수
- **기본값**: 데이터가 없을 경우 기본값 처리
- **타입 변환**: API 응답 데이터 타입 확인 및 변환

---

## 5. 배포 및 운영 규칙

### 5.1 배포 프로세스
- **Git 워크플로우**: `main` 브랜치에 푸시 시 자동 배포
- **마이그레이션**: 배포 전 DB 마이그레이션 실행
- **롤백**: 배포 실패 시 자동 롤백 가능하도록 구성

### 5.2 환경 변수
- **로컬 개발**: `.env` 파일 사용 (Git에 커밋하지 않음)
- **서버 배포**: 환경 변수는 서버에서 직접 설정
- **문서화**: 환경 변수 목록은 문서에 명시

### 5.3 로깅
- **로그 레벨**: DEBUG, INFO, WARNING, ERROR 구분
- **로그 파일**: 백엔드는 `backend.log`, 프론트엔드는 `frontend.log`
- **로그 로테이션**: 로그 파일 크기 제한 및 로테이션

### 5.4 모니터링
- **서비스 상태**: Systemd 서비스로 관리
- **헬스 체크**: `/health` 엔드포인트로 서비스 상태 확인
- **알림**: 에러 발생 시 알림 시스템 연동

---

## 6. 문서화 규칙

### 6.1 문서 구조
```
docs/
├── deployment/      # 배포 메뉴얼
├── scanner-v2/      # Scanner V2 문서
├── database/        # DB 스키마 문서
├── API_ENDPOINTS.md # API 엔드포인트 문서
└── PROJECT_OVERVIEW.md # 프로젝트 개요
```

### 6.2 문서 작성
- **마크다운**: 모든 문서는 Markdown 형식
- **업데이트**: 코드 변경 시 관련 문서도 함께 업데이트
- **예시 코드**: 문서에 실제 동작하는 예시 코드 포함

### 6.3 주석
- **함수/클래스**: 모든 공개 함수/클래스에 docstring 작성
- **복잡한 로직**: 복잡한 비즈니스 로직에 주석 추가
- **TODO**: 임시 코드는 TODO 주석과 함께 작성

---

## 7. 테스트 규칙

### 7.1 백엔드 테스트
- **단위 테스트**: 핵심 비즈니스 로직에 단위 테스트 작성
- **통합 테스트**: API 엔드포인트에 통합 테스트 작성
- **테스트 파일**: `backend/tests/` 디렉토리에 작성

### 7.2 프론트엔드 테스트
- **Jest**: Jest + React Testing Library 사용
- **컴포넌트 테스트**: 주요 컴포넌트에 테스트 작성
- **테스트 파일**: `frontend/__tests__/` 디렉토리에 작성
- **커버리지**: `npm run test:coverage`로 커버리지 확인

### 7.3 테스트 실행
- **로컬**: 개발 중 로컬에서 테스트 실행
- **CI/CD**: GitHub Actions에서 자동 테스트 실행 (필요한 경우)

---

## 8. 버전 관리 규칙

### 8.1 Git 워크플로우
- **브랜치 전략**: `main` 브랜치를 프로덕션으로 사용
- **커밋 메시지**: 명확하고 구체적인 커밋 메시지 작성
- **커밋 단위**: 논리적으로 관련된 변경사항만 함께 커밋

### 8.2 코드 리뷰
- **자체 리뷰**: 커밋 전 코드 자체 리뷰 수행
- **문서화**: 복잡한 변경사항은 문서로 정리

---

## 9. 보안 규칙

### 9.1 인증/인가
- **JWT 토큰**: 인증은 JWT 토큰 사용
- **토큰 만료**: 토큰 만료 시간 적절히 설정
- **권한 관리**: 관리자/일반 사용자 권한 분리

### 9.2 데이터 보안
- **XSS 방지**: 사용자 입력은 `isomorphic-dompurify`로 sanitize
- **CSRF 보호**: CSRF 토큰 사용 (필요한 경우)
- **SQL 인젝션**: 파라미터화된 쿼리 사용

### 9.3 환경 변수
- **민감 정보**: API 키, 비밀번호 등은 환경 변수로 관리
- **Git 제외**: `.env` 파일은 `.gitignore`에 추가

---

## 10. 성능 규칙

### 10.1 백엔드 성능
- **캐싱**: 자주 조회되는 데이터는 캐싱
- **비동기**: I/O 작업은 비동기 처리 (FastAPI async/await)
- **쿼리 최적화**: N+1 쿼리 문제 방지

### 10.2 프론트엔드 성능
- **코드 스플리팅**: Next.js 동적 import 활용
- **이미지 최적화**: Next.js Image 컴포넌트 사용
- **메모이제이션**: React.memo, useMemo 적절히 활용

---

## 11. 특수 규칙

### 11.1 Scanner V1/V2
- **버전 분리**: V1과 V2는 완전히 분리된 코드로 관리
- **DB 설정**: 버전 선택은 DB의 `scanner_settings` 테이블에서 관리
- **결과 저장**: 스캔 결과는 버전별로 분리 저장

### 11.2 Regime 분석
- **버전 관리**: v1/v3/v4 버전 지원
- **캐싱**: 레짐 분석 결과는 캐싱하여 성능 최적화
- **Fallback**: 분석 실패 시 이전 버전으로 fallback

### 11.3 OHLCV 데이터
- **캐싱**: 메모리 캐시 + 디스크 캐시 조합
- **TTL**: 데이터 특성에 따른 동적 TTL 설정
- **백테스트**: 디스크 캐시를 백테스트에 활용

---

## 12. 금지 사항

### 12.1 절대 하지 말아야 할 것
- ❌ API 키를 코드에 하드코딩
- ❌ `.env` 파일을 Git에 커밋
- ❌ 프로덕션 DB에 직접 쿼리 실행 (필요 시 백업 후)
- ❌ 테스트 없이 프로덕션 배포
- ❌ 문서 없이 복잡한 기능 추가

### 12.2 지양해야 할 것
- ❌ ORM 사용 (SQL 직접 작성)
- ❌ 클래스 컴포넌트 사용 (함수형 컴포넌트 사용)
- ❌ 긴 함수/클래스 (100줄 이상 시 분리 고려)
- ❌ 중복 코드 (공통 로직은 함수/모듈로 분리)

---

## 13. 우선순위

### 13.1 개발 우선순위
1. **보안**: 보안 이슈는 최우선으로 처리
2. **버그 수정**: 프로덕션 버그는 즉시 수정
3. **기능 추가**: 새로운 기능은 계획 후 추가
4. **리팩토링**: 기술 부채는 점진적으로 개선

### 13.2 테스트 우선순위
1. **인증 플로우**: 인증 관련 테스트 최우선
2. **API 통신**: API 엔드포인트 테스트
3. **주요 페이지**: 사용자 주요 경로 테스트
4. **유틸리티**: 유틸리티 함수 테스트

---

## 14. 참고 문서

- [프로젝트 개요](./docs/PROJECT_OVERVIEW.md)
- [API 엔드포인트](./docs/API_ENDPOINTS.md)
- [로컬 개발 환경 구성](./docs/deployment/LOCAL_DEVELOPMENT_SETUP.md)
- [서버 운영 메뉴얼](./docs/deployment/SERVER_OPERATION_MANUAL.md)
- [Scanner V2 가이드](./docs/scanner-v2/SCANNER_V2_USAGE.md)
- [문제 해결 가이드](./docs/TROUBLESHOOTING_GUIDE.md)

---

**마지막 업데이트**: 2025-11-27

