# 며칠간 추세 기반 장세 분석

## 개선 배경

**기존 문제점:**
- 하루(전일 대비 당일)만 보고 장세 판단
- 단기 변동성에 민감하게 반응
- 노이즈에 취약

**개선 목표:**
- 며칠간의 추세를 반영하여 더 안정적인 장세 판단
- 단기 변동성과 장기 추세를 구분
- 노이즈 제거

## 구현 방법

### 1. 데이터 수집

```python
# 최근 5일 데이터 수집
lookback_days = 5
df = api.get_ohlcv("069500", lookback_days, date)
```

### 2. 추세 계산

**단기 추세 (최근 3일):**
- 가중치: [0.2, 0.3, 0.5] (최근일수록 높은 가중치)
- 의미: 최근 3일간의 추세

**중기 추세 (최근 5일):**
- 가중치: [0.1, 0.15, 0.2, 0.25, 0.3] (최근일수록 높은 가중치)
- 의미: 최근 5일간의 추세

**당일 수익률:**
- 전일 대비 당일 수익률
- 의미: 당일 시장 반응

### 3. 최종 수익률 계산

```python
# 가중 평균: 단기(50%) + 중기(30%) + 당일(20%)
close_return = (
    weighted_3d * 0.5 +    # 단기 추세 50%
    weighted_5d * 0.3 +   # 중기 추세 30%
    daily_return * 0.2     # 당일 20%
)
```

**의미:**
- 단기 추세에 가장 높은 가중치 (50%)
- 중기 추세로 안정성 확보 (30%)
- 당일 반응도 반영 (20%)

### 4. 변동성 계산

```python
# 며칠간의 평균 변동성
volatilities = []
for i in range(max(0, current_idx - 4), current_idx + 1):
    vol = (high - low) / close
    volatilities.append(vol)

volatility = sum(volatilities) / len(volatilities)
```

## 장세 판단 기준 조정

며칠간의 추세를 반영했으므로 기준을 약간 완화:

| 장세 | 기존 (하루 기준) | 개선 (추세 반영) | 이유 |
|------|----------------|-----------------|------|
| **bull** | `> +1.5%` | `> +1.0%` | 며칠간의 추세가 +1.0%면 상당한 상승 |
| **neutral** | `-1.5% ~ +1.5%` | `-1.0% ~ +1.0%` | 범위 축소 |
| **bear** | `< -1.5%` | `< -1.0%` | 며칠간의 추세가 -1.0%면 하락세 |
| **crash** | `< -3.0%` | `< -2.5%` | 며칠간의 추세가 -2.5%면 급락 |

## 장점

1. **안정성 향상**
   - 하루 변동성에 덜 민감
   - 노이즈 제거

2. **정확성 향상**
   - 며칠간의 추세를 반영하여 더 정확한 장세 판단
   - 단기 변동성과 장기 추세 구분

3. **일관성 향상**
   - 며칠간의 데이터로 판단하므로 일관된 결과

## 예시

### 시나리오 1: 하루 상승, 며칠 하락

**하루 기준:**
- 당일: +1.2% → neutral

**추세 반영:**
- 당일: +1.2%
- 최근 3일: -0.3% (하락 추세)
- 최근 5일: -0.5% (하락 추세)
- 최종: +0.2% → neutral (하지만 하락 압력 반영)

### 시나리오 2: 며칠간 지속 상승

**하루 기준:**
- 당일: +0.8% → neutral

**추세 반영:**
- 당일: +0.8%
- 최근 3일: +1.2% (상승 추세)
- 최근 5일: +1.0% (상승 추세)
- 최종: +1.0% → bull (지속 상승 반영)

## 로그 예시

```
KOSPI 추세 분석: 당일=+1.20%, 3일평균=+0.50%, 5일평균=+0.30%, 최종=+0.65%
```

- 당일: 전일 대비 당일 수익률
- 3일평균: 최근 3일 가중 평균 수익률
- 5일평균: 최근 5일 가중 평균 수익률
- 최종: 최종 계산된 수익률 (가중 평균)

## 향후 개선 방향

1. **가중치 튜닝**
   - 현재 가중치가 최적인지 검증
   - 시장 상황에 따라 동적 조정

2. **추세 강도 추가**
   - 상승 추세의 강도 측정
   - 하락 추세의 강도 측정

3. **볼륨 분석 추가**
   - 거래량 추세 분석
   - 거래량과 가격 추세의 일치 여부

