# 병렬 스캔 리소스 이슈 분석

**작성일**: 2026-01-08  
**목적**: v2와 v3 병렬 실행 시 리소스 경합 및 제약 사항 분석

---

## 리소스 분석

### 1. 데이터베이스 연결 풀 ✅

**현재 설정**:
```python
# backend/db.py
_pool = ConnectionPool(
    conninfo=config.database_url,
    min_size=1,
    max_size=10,  # 최대 10개 연결
)
```

**병렬 실행 시**:
- v2 스캔: 약 2-3개 연결 사용 (조회 + 저장)
- v3 스캔: 약 2-3개 연결 사용 (조회 + 저장)
- **총 필요 연결**: 약 4-6개
- **사용 가능 연결**: 10개
- **결론**: ✅ 충분한 여유 (40% 사용)

**이슈**: 없음

---

### 2. 키움 API 레이트 리밋 ⚠️

**현재 구현**:
```python
# backend/kiwoom_api.py
def _post(self, api_id: str, path: str, payload: dict, ...):
    # ...
    time.sleep(config.rate_limit_delay_ms / 1000.0)  # 레이트 리밋 준수
```

**문제점**:
- 단일 API 인스턴스 사용 (`api = KiwoomAPI()`)
- 병렬 실행 시 동일한 API 인스턴스에 동시 접근
- 레이트 리밋이 스레드 안전하지 않을 수 있음
- 두 스레드가 동시에 API 호출 시 레이트 리밋 위반 가능

**예상 시나리오**:
1. v2 스캔: 종목 1 API 호출 → `time.sleep(0.25)` 시작
2. v3 스캔: 종목 1 API 호출 → `time.sleep(0.25)` 시작 (동시)
3. 두 스레드가 거의 동시에 API 호출
4. 레이트 리밋 위반 가능성

**해결 방안**:
1. **API 인스턴스 분리** (권장)
   - v2와 v3가 각각 독립적인 API 인스턴스 사용
   - 레이트 리밋이 각각 독립적으로 적용

2. **락(Lock) 사용**
   - API 호출 시 락으로 동기화
   - 레이트 리밋 보장

3. **현재 상태 유지**
   - 레이트 리밋이 충분히 여유 있으면 문제 없을 수 있음
   - 모니터링 후 문제 발생 시 조치

**이슈**: ⚠️ 주의 필요 (레이트 리밋 위반 가능성)

---

### 3. 메모리 사용량

**현재 사용량** (순차 실행):
- v2 스캔: 약 1.5-2GB
- v3 스캔: 약 1.5-2GB
- **총**: 약 3-4GB

**병렬 실행 시**:
- v2 + v3 동시 실행: 약 3-4GB
- **피크 사용량**: 약 4-5GB (일시적)

**서버 사양 가정**:
- 메모리: 8GB 이상
- **결론**: ✅ 충분한 여유

**이슈**: 없음 (서버 사양에 따라 다름)

---

### 4. CPU 사용량

**현재 사용량** (순차 실행):
- v2 스캔: 평균 50-70%
- v3 스캔: 평균 50-70%

**병렬 실행 시**:
- v2 + v3 동시 실행: 평균 80-100%
- **피크 사용량**: 100% (일시적)

**서버 사양 가정**:
- CPU: 4코어 이상
- **결론**: ⚠️ 높은 사용률 (다른 작업 영향 가능)

**이슈**: ⚠️ 주의 필요 (다른 작업 성능 저하 가능)

---

### 5. 캐시 경합

**OHLCV 캐시**:
- 메모리 기반 캐시 (`_ohlcv_cache`)
- 병렬 실행 시 동일한 캐시에 동시 접근
- 읽기 작업이므로 큰 문제 없음

**레짐 분석 캐시**:
- 디스크 기반 캐시
- 병렬 실행 시 동시 읽기 가능
- 문제 없음

**이슈**: 없음

---

## 종합 평가

### 리소스 이슈 우선순위

| 리소스 | 순위 | 이슈 | 심각도 | 해결 방안 |
|--------|------|------|--------|----------|
| 키움 API 레이트 리밋 | 1 | 동시 접근 시 위반 가능 | ⚠️ 중간 | API 인스턴스 분리 |
| CPU 사용량 | 2 | 80-100% 사용 | ⚠️ 낮음 | 모니터링 |
| DB 연결 풀 | 3 | 충분한 여유 | ✅ 없음 | - |
| 메모리 | 4 | 충분한 여유 | ✅ 없음 | - |
| 캐시 | 5 | 문제 없음 | ✅ 없음 | - |

---

## 권장 사항

### 옵션 1: 순차 실행 유지 (현재) ⭐

**장점**:
- 리소스 이슈 없음
- 구현 간단
- 안정성 높음

**단점**:
- 실행 시간 2배 (4-6분)

**권장**: 리소스 이슈를 피하고 안정성을 우선하는 경우

---

### 옵션 2: 병렬 실행 + API 인스턴스 분리

**변경 사항**:
1. v2와 v3가 각각 독립적인 API 인스턴스 사용
2. 병렬 실행 구현

**장점**:
- 실행 시간 단축 (2-3분)
- 레이트 리밋 문제 해결

**단점**:
- 구현 복잡도 증가
- CPU 사용량 높음

**권장**: 실행 시간 단축이 중요한 경우

---

### 옵션 3: 병렬 실행 + 락 사용

**변경 사항**:
1. API 호출 시 락으로 동기화
2. 레이트 리밋 보장

**장점**:
- 레이트 리밋 문제 해결
- 단일 API 인스턴스 유지

**단점**:
- 병렬화 이점 제한적 (락으로 인한 대기)
- 실행 시간 단축 효과 감소

**권장**: API 인스턴스 분리가 어려운 경우

---

## 최종 권장 사항

### 현재: 순차 실행 유지 ⭐

**이유**:
1. 리소스 이슈 없음
2. 안정성 높음
3. 구현 간단
4. 실행 시간 4-6분은 허용 가능

### 향후 개선: 병렬 실행 고려

**조건**:
1. API 인스턴스 분리 구현
2. CPU 사용량 모니터링
3. 레이트 리밋 위반 모니터링
4. 성능 테스트 완료 후 적용

---

**작성일**: 2026-01-08  
**최종 업데이트**: 2026-01-08  
**상태**: 분석 완료, 권장 사항 제시

