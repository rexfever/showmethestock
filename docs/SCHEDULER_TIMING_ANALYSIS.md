# 스케줄러 실행 시간 충돌 분석

**작성일**: 2026-01-08  
**목적**: v2/v3 동시 스캔으로 인한 실행 시간 충돌 분석 및 해결 방안

---

## 현재 스케줄러 실행 시간

| 시간 | 작업 | 예상 소요 시간 | 완료 예상 시간 |
|------|------|---------------|---------------|
| 15:40 | 장세 분석 | 약 1분 | 15:41 |
| 15:42 | 스캔 실행 (v2 + v3) | 약 4-6분 | 15:46~15:48 |
| 15:45 | 상태 평가 | 약 1-2분 | 15:46~15:47 |

---

## 충돌 가능성 분석

### 문제점

1. **시간 겹침**
   - 스캔 시작: 15:42
   - 스캔 완료 예상: 15:46~15:48
   - 상태 평가 시작: 15:45
   - **충돌 구간**: 15:45~15:48 (약 3분)

2. **리소스 경합**
   - 스캔: CPU/메모리 집약적 (70-90%)
   - 상태 평가: DB 조회 및 업데이트
   - 동시 실행 시 리소스 경합 가능

3. **DB 경합**
   - 스캔: `scan_rank` 테이블에 쓰기
   - 상태 평가: `recommendations` 테이블 읽기/쓰기
   - 직접적인 충돌은 없지만 성능 저하 가능

---

## 해결 방안

### 옵션 1: 상태 평가 시간 조정 (권장) ⭐

**변경 내용**:
- 상태 평가 시간을 15:45 → 15:47로 변경
- 스캔 완료 후 실행 보장

**장점**:
- 구현 간단
- 스캔 완료 후 상태 평가 보장
- 리소스 경합 최소화

**단점**:
- 상태 평가가 약 2분 지연

**코드 변경**:
```python
# 변경 전
schedule.every().day.at("15:45").do(run_status_evaluation)

# 변경 후
schedule.every().day.at("15:47").do(run_status_evaluation)
```

---

### 옵션 2: 스캔 시간 분산

**변경 내용**:
- v2 스캔: 15:42
- v3 스캔: 15:43
- 상태 평가: 15:45 (유지)

**장점**:
- 각 스캔이 독립적으로 실행
- 한 스캔 실패해도 다른 스캔 영향 없음

**단점**:
- 구현 복잡도 증가
- 스케줄 관리 복잡

**코드 변경**:
```python
def run_scan_v2():
    """v2 스캔 실행"""
    ...

def run_scan_v3():
    """v3 스캔 실행"""
    ...

schedule.every().day.at("15:42").do(run_scan_v2)
schedule.every().day.at("15:43").do(run_scan_v3)
```

---

### 옵션 3: 스캔 완료 후 상태 평가 실행 (콜백 방식)

**변경 내용**:
- `run_scan()` 함수 내에서 스캔 완료 후 상태 평가 실행
- 스케줄러에서 상태 평가 제거

**장점**:
- 스캔 완료 보장
- 리소스 경합 없음

**단점**:
- 스캔 실패 시 상태 평가도 실행 안 됨
- 스케줄러 구조 변경 필요

---

## 권장 사항

### 즉시 적용: 옵션 1 (상태 평가 시간 조정)

**이유**:
1. 구현 간단 (한 줄 수정)
2. 스캔 완료 후 상태 평가 보장
3. 리소스 경합 최소화
4. 기존 로직 변경 없음

**변경 내용**:
```python
# backend/scheduler.py
schedule.every().day.at("15:47").do(run_status_evaluation)  # 15:45 → 15:47
```

**예상 타임라인**:
- 15:42: 스캔 시작 (v2 + v3)
- 15:46~15:48: 스캔 완료
- 15:47: 상태 평가 시작 (스캔 완료 후)
- 15:48~15:49: 상태 평가 완료

---

### 추가 고려 사항

#### 1. 스캔 실행 시간 모니터링
- 실제 실행 시간 측정
- 필요 시 시간 조정

#### 2. 타임아웃 설정
- 현재 v2/v3 각각 300초 타임아웃
- 충분한 여유 있음

#### 3. 에러 처리
- 한 스캔 실패해도 다른 스캔 실행
- 상태 평가는 스캔 완료 후 실행

---

## 최종 권장 스케줄

| 시간 | 작업 | 비고 |
|------|------|------|
| 15:40 | 장세 분석 | 기존 유지 |
| 15:42 | 스캔 실행 (v2 + v3) | 순차 실행 |
| 15:47 | 상태 평가 | **15:45 → 15:47 변경** |

**이유**:
- 스캔 완료 후 상태 평가 보장
- 리소스 경합 최소화
- 구현 간단

---

**작성일**: 2026-01-08  
**최종 업데이트**: 2026-01-08  
**상태**: 분석 완료, 권장 사항 제시

