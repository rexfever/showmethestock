# SQLite → PostgreSQL 마이그레이션 사전 조사 (Step 1)

## 1. 현재 SQLite 파일 및 용도
- `snapshots.db`: 주요 비즈니스 데이터 (스캔 결과, 사용자, 구독/결제, 유지보수 설정 등)
- `portfolio.db`: 사용자 포트폴리오 및 거래 이력
- `email_verifications.db`: 이메일 인증 코드
- `news_data.db`: 뉴스 및 검색 트렌드 데이터
- `users.db`: (빈 DB, 과거 테스트 용도로 추정)

> 운영 데이터는 사실상 `snapshots.db`, `portfolio.db`, `email_verifications.db`, `news_data.db` 네 개에 집중되어 있음. PostgreSQL로 이관 시 단일 스키마로 통합하는 편이 관리상 유리.

## 2. 주요 테이블 구조 요약

### 2.1 `snapshots.db`
- `users`: 로그인/소셜 사용자 정보  
  - `AUTOINCREMENT`, `TEXT` 기반 타임스탬프, boolean 필드는 `BOOLEAN DEFAULT 0`
- `subscriptions`, `payments`: 정규 FK 제약 선언(`FOREIGN KEY`)  
- `scan_rank`: 일자·종목별 스캔 결과 (복합 PK `PRIMARY KEY(date, code, scanner_version)`)
- `positions`, `positions_old`, `send_logs`, `popup_notice`, `maintenance_settings`, `market_conditions`, `scan_rank_backup`
- 모든 날짜/시간 필드가 `TEXT` 혹은 `TIMESTAMP` 문자열로 저장되고 있음
- BOOLEAN은 0/1로 저장되며 SQLite에서는 캐스팅 없이 사용됨

### 2.2 `portfolio.db`
- `portfolio`: 사용자별 보유 종목  
  - `UNIQUE(user_id, ticker)` 제약, 다수의 INDEX 존재
- `trading_history`: 매매 이력 (인덱스 3개)

### 2.3 `email_verifications.db`
- 단일 테이블 `email_verifications` (만료 시각, 검증 여부)

### 2.4 `news_data.db`
- `news_data`: 기사 데이터 (`sentiment_score`, `relevance_score`)  
- `search_trends`: 검색량/트렌드 정보

## 3. PostgreSQL 전환 시 스키마 매핑 이슈

| 항목 | 현재(SQLite) | PostgreSQL 권장 매핑 | 비고 |
|------|--------------|----------------------|------|
| PK | `INTEGER PRIMARY KEY AUTOINCREMENT` | `SERIAL` / `BIGSERIAL` | 시퀀스 자동 생성 확인 |
| 날짜·시간 | `TEXT DEFAULT CURRENT_TIMESTAMP` | `TIMESTAMP WITH TIME ZONE DEFAULT NOW()` | 기존 데이터 `YYYY-MM-DD` 등 문자열 → 날짜 변환 필요 |
| 불리언 | `BOOLEAN DEFAULT 0/1` | `BOOLEAN DEFAULT FALSE/TRUE` | 데이터 로드시 `0/1` → `false/true` 변환 |
| 복합 PK (`scan_rank`) | `PRIMARY KEY(date, code, scanner_version)` | `scanner_version` 컬럼 추가 | V1과 V2 스캔 결과를 별도로 저장 |
| FK 제약 | 선언되어 있으나 SQLite에서 느슨하게 동작 | PostgreSQL에서 강제 | 기존 데이터 무결성 검증 필요 |
| 텍스트 | `TEXT` | `TEXT` 또는 `VARCHAR(n)` | 길이 제한 필요한 필드는 재검토 |
| JSON 칼럼 | 문자열(JSON) 저장 | `JSONB` 고려 | `indicators`, `details`, `returns` 등 JSON 문자열 가능성 |


## 4. 애플리케이션 코드의 DB 의존성

- 대부분 `sqlite3` 모듈 직접 사용 (`sqlite3.connect`, `cursor.execute`)  
- 파라미터 바인딩이 `?` 플레이스홀더 기반 → `psycopg` 전환 시 `%s` 형식으로 교체 필요
- 주요 DB 접근 모듈
  - `backend/main.py`: 사용자/포지션/스캔/공지/유지보수 API 전반
  - `backend/services/scan_service.py`: `scan_rank` 조회/저장
  - `backend/portfolio_service.py`, `subscription_service.py`, `notification_service.py`, `email_service.py`, `admin_service.py`, `auth_service.py` 등
- 테스트 코드에서도 다수의 직접 SQL 실행이 존재 → 마이그레이션 후 테스트 업데이트 필요
- 현재는 각 기능별로 서로 다른 DB 파일을 열어 사용 (`snapshots.db`, `portfolio.db` 등을 별도로 connect)


## 5. 권장 마이그레이션 방향성

1. **단일 PostgreSQL 스키마로 통합**  
   - `snapshots.db` 중심 테이블 → `public` 스키마로 이관  
   - `portfolio`, `news`, `email_verifications` 테이블도 동일 DB 내 별도 테이블로 통합 (스키마 분리 필요 시 `portfolio`, `news` 서브 스키마 고려)

2. **일관된 타입 정의**  
   - 날짜/시간: `DATE`, `TIMESTAMP WITH TIME ZONE`  
   - 금액/점수: `NUMERIC(10,2)` 혹은 `DOUBLE PRECISION` 등 목적에 맞게 선택  
   - JSON 필드(`indicators`, `details`, `returns`, `recurrence`)는 `JSONB`로 정의하여 질의 최적화 준비

3. **시퀀스 및 기본값**  
   - `SERIAL` 대신 `GENERATED BY DEFAULT AS IDENTITY` 사용 검토  
   - 문자열 기본값과 ENUM 후보 (`membership_tier`, `subscription_status` 등)는 향후 `ENUM` 타입 도입 가능

4. **FK 및 인덱스 재정비**  
   - PostgreSQL은 FK를 강하게 검사 → 기존 데이터 무결성 사전 점검  
   - 자주 사용하는 조회(예: `scan_rank(date)`, `portfolio(user_id)`)에 필요한 인덱스 재생성

5. **접속 계층 리팩터링**  
   - DB 접속 모듈을 공통화 (`db_manager.py` 등)  
   - 환경 변수로 `sqlite` / `postgresql` 드라이버 분기 → 단계적 전환 가능  
   - `psycopg` 혹은 `asyncpg` + SQLAlchemy 도입 여부 결정 (장기적으로 ORM 추천)

6. **데이터 이행 준비**  
   - 현재 DB 용량·행 수 파악, CSV 또는 SQL Dump 후 ETL 스크립트 작성  
   - 문자열 날짜를 `DATE/TIMESTAMP`로 변환하는 전처리 로직 필수  
   - 불리언/ENUM 후보 값 검증


## 6. 다음 단계 제안

1. PostgreSQL 개발 DB에 위 스키마를 수동으로 반영하면서 타입 호환성 검증  
2. 마이그레이션 스크립트(예: `scripts/migrate_sqlite_to_pg.py`) 작성  
3. 애플리케이션에서 연결 문자열을 환경변수로 교체하고, 신규 드라이버 테스트  
4. 테스트 및 QA 환경에서 PostgreSQL만으로 기능 검증 후 프로덕션 전환 계획 수립

---

### 📦 진행 현황 (업데이트)
- `backend/sql/postgres_schema.sql`: PostgreSQL용 통합 스키마 초안 작성  
- `backend/migrations/sqlite_to_postgres.py`: 테이블 매핑·변환 로직을 포함한 마이그레이션 스크립트 골격 구현  
- 다음 스텝: 실제 데이터 변환 결과 검증, 변환 시나리오(샘플/전체) 실행, 애플리케이션 DB 드라이버 전환 테스트

### ✅ 2025-11-08 갱신
- 로컬 PostgreSQL (`stockfinder`) 생성 후 스키마 적용 완료  
- `sqlite_to_postgres.py` 실행하여 주요 테이블 데이터 이관 성공  
  - `scan_rank` 437건, `users` 53건, `portfolio` 10건 등 확인  
- 중복 PK(`date, code`)는 `ON CONFLICT DO NOTHING` 처리로 안전하게 무시  
- 다음 단계: 애플리케이션을 PostgreSQL로 연결해 통합 테스트, 배포 전략 수립


