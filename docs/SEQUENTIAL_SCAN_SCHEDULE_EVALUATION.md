# 순차 실행 스케줄 적절성 평가

**작성일**: 2026-01-08  
**목적**: 현재 순차 실행 스케줄의 적절성 평가 및 개선 방안

---

## 현재 스케줄

| 시간 | 작업 | 예상 소요 시간 | 완료 예상 시간 |
|------|------|---------------|---------------|
| 15:40 | 장세 분석 | 약 10초~1분 | 15:40~15:41 |
| 15:43 | 스캔 실행 (v2 + v3 순차) | 약 4-6분 | 15:47~15:49 |
| 15:47 | 상태 평가 | 약 1-2분 | 15:48~15:49 |

---

## 적절성 평가

### ✅ 적절한 부분

1. **장세 분석 완료 후 스캔 시작**
   - 15:40 장세 분석 → 15:43 스캔 시작
   - 약 2-3분 여유로 장세 분석 완료 보장
   - ✅ 적절

2. **리소스 사용량**
   - 순차 실행으로 CPU/메모리 사용량 예측 가능
   - 리소스 경합 최소화
   - ✅ 적절

3. **에러 처리**
   - 한 스캔 실패해도 다른 스캔 실행
   - 독립적인 에러 처리
   - ✅ 적절

---

### ⚠️ 개선 필요한 부분

1. **스캔 완료 전 상태 평가 시작 가능성**
   - 스캔 시작: 15:43
   - 스캔 완료 예상: 15:47~15:49
   - 상태 평가 시작: 15:47
   - **문제**: 스캔이 지연되면 상태 평가가 스캔 완료 전에 시작될 수 있음
   - ⚠️ 개선 필요

2. **시간 여유 부족**
   - 스캔 완료 예상: 15:47~15:49
   - 상태 평가 시작: 15:47
   - **여유 시간**: 0분 (최악의 경우)
   - ⚠️ 개선 필요

3. **스캔 실행 시간 변동성**
   - v2: 약 2-3분 (변동 가능)
   - v3: 약 2-3분 (변동 가능)
   - 총: 약 4-6분 (최대 6분까지 가능)
   - 상태 평가가 15:47에 시작하면 스캔 완료 전일 수 있음
   - ⚠️ 개선 필요

---

## 문제 시나리오

### 시나리오 1: 정상 실행
- 15:43: 스캔 시작
- 15:47: 스캔 완료 (4분 소요)
- 15:47: 상태 평가 시작 (스캔 완료 후)
- ✅ 문제 없음

### 시나리오 2: 스캔 지연
- 15:43: 스캔 시작
- 15:47: 스캔 진행 중 (아직 완료 안 됨)
- 15:47: 상태 평가 시작 (스캔 완료 전)
- ⚠️ **충돌 가능성**

### 시나리오 3: 스캔 최대 지연
- 15:43: 스캔 시작
- 15:49: 스캔 완료 (6분 소요)
- 15:47: 상태 평가 시작 (스캔 완료 전)
- ⚠️ **충돌 발생**

---

## 개선 방안

### 옵션 1: 상태 평가 시간 조정 (권장) ⭐

**변경 내용**:
- 상태 평가 시간을 15:47 → 15:49로 변경
- 스캔 완료 후 실행 보장

**장점**:
- 구현 간단 (한 줄 수정)
- 스캔 완료 후 상태 평가 보장
- 충분한 여유 시간 확보

**단점**:
- 상태 평가가 약 2분 지연

**코드 변경**:
```python
# backend/scheduler.py
schedule.every().day.at("15:49").do(run_status_evaluation)  # 15:47 → 15:49
```

**예상 타임라인**:
- 15:43: 스캔 시작 (v2 + v3)
- 15:47~15:49: 스캔 완료
- 15:49: 상태 평가 시작 (스캔 완료 후)
- 15:50~15:51: 상태 평가 완료

---

### 옵션 2: 스캔 완료 후 콜백으로 상태 평가 실행

**변경 내용**:
- `run_scan()` 함수 내에서 스캔 완료 후 상태 평가 실행
- 스케줄러에서 상태 평가 제거

**장점**:
- 스캔 완료 보장
- 리소스 경합 없음
- 시간 여유 불필요

**단점**:
- 스캔 실패 시 상태 평가도 실행 안 됨
- 스케줄러 구조 변경 필요

**코드 변경**:
```python
def run_scan():
    """한국 주식 스캔 실행 (15:43) - v2와 v3 모두 실행"""
    # ... 스캔 실행 ...
    
    # 스캔 완료 후 상태 평가 실행
    if success_v2 or success_v3:
        logger.info("스캔 완료, 상태 평가 시작...")
        from services.state_transition_service import evaluate_active_recommendations
        try:
            stats = evaluate_active_recommendations()
            logger.info(f"상태 평가 완료: {stats}")
        except Exception as e:
            logger.error(f"상태 평가 오류: {e}")
```

---

### 옵션 3: 상태 평가 시간을 더 늦게 조정

**변경 내용**:
- 상태 평가 시간을 15:47 → 15:50으로 변경
- 충분한 여유 시간 확보

**장점**:
- 구현 간단
- 충분한 여유 시간

**단점**:
- 상태 평가가 약 3분 지연

---

## 권장 사항

### 즉시 적용: 옵션 1 (상태 평가 시간 조정) ⭐

**이유**:
1. 구현 간단 (한 줄 수정)
2. 스캔 완료 후 상태 평가 보장
3. 충분한 여유 시간 확보
4. 기존 로직 변경 없음

**변경 내용**:
```python
# backend/scheduler.py
schedule.every().day.at("15:49").do(run_status_evaluation)  # 15:47 → 15:49
```

---

## 최종 권장 스케줄

| 시간 | 작업 | 예상 소요 시간 | 완료 예상 시간 | 비고 |
|------|------|---------------|---------------|------|
| 15:40 | 장세 분석 | 약 10초~1분 | 15:40~15:41 | 기존 유지 |
| 15:43 | 스캔 실행 (v2 + v3) | 약 4-6분 | 15:47~15:49 | 순차 실행 |
| 15:49 | 상태 평가 | 약 1-2분 | 15:50~15:51 | **15:47 → 15:49 변경** |

**이유**:
- 장세 분석 완료 후 스캔 보장
- 스캔 완료 후 상태 평가 보장
- 충분한 여유 시간 (최소 0분, 최대 2분)
- 리소스 경합 최소화

---

## 적절성 종합 평가

### 현재 스케줄 (15:47 상태 평가)
- **적절성**: ⚠️ 부분적 (스캔 지연 시 충돌 가능)
- **개선 필요**: ✅ 필요

### 개선된 스케줄 (15:49 상태 평가)
- **적절성**: ✅ 적절
- **개선 필요**: ❌ 불필요

---

## 결론

**현재 순차 실행 스케줄은 부분적으로 적절하지만, 상태 평가 시간 조정이 필요합니다.**

**즉시 조치**:
- 상태 평가 시간을 15:47 → 15:49로 변경
- 스캔 완료 후 상태 평가 보장

**장기 개선**:
- 스캔 실행 시간 모니터링
- 필요 시 콜백 방식으로 전환 고려

---

**작성일**: 2026-01-08  
**최종 업데이트**: 2026-01-08  
**상태**: 평가 완료, 개선 방안 제시

