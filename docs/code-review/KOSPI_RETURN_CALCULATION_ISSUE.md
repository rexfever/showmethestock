# KOSPI 수익률 계산 문제 분석

**작성일**: 2025-11-26

## 문제 상황

- **실제 KOSPI 지수 상승률**: 2.67%
- **시스템 계산 결과**: 1.64% (effective_return)
- **당일 수익률 (KOSPI200)**: 2.70%

## 원인 분석

### 1. 지수 차이

현재 코드는 **KOSPI200 지수 (069500)**를 사용하고 있습니다:
- KOSPI200: 대형주 200개 종목으로 구성된 지수
- KOSPI: 전체 상장 종목을 포함한 종합 지수

두 지수의 수익률이 다를 수 있습니다.

### 2. 가중 평균 계산

현재 로직은 며칠간의 추세를 반영한 가중 평균을 사용합니다:

```python
# 최종 수익률: 단기 추세(50%) + 중기 추세(30%) + 당일(20%) 가중 평균
close_return = (weighted_3d * 0.5 + weighted_5d * 0.3 + daily_return * 0.2)
```

**계산 예시 (2025-11-26)**:
- 당일 수익률: +2.70%
- 3일 평균: +1.96%
- 5일 평균: +0.40%
- **최종**: (1.96 * 0.5) + (0.40 * 0.3) + (2.70 * 0.2) = **1.64%**

### 3. 문제점

1. **지수 선택**: KOSPI200 vs KOSPI 지수
2. **가중 평균**: 당일 수익률이 높아도 과거 추세 때문에 낮게 계산됨
3. **표시 불일치**: 사용자가 보는 수익률과 시스템이 사용하는 수익률이 다름

## 해결 방안

### 옵션 1: 당일 수익률 우선 사용

당일 수익률이 높을 때는 가중 평균 대신 당일 수익률을 사용:

```python
if abs(daily_return) > 0.02:  # 2% 이상 변동
    close_return = daily_return  # 당일 수익률 사용
else:
    close_return = (weighted_3d * 0.5 + weighted_5d * 0.3 + daily_return * 0.2)
```

### 옵션 2: KOSPI 지수 사용

KOSPI 지수 코드를 찾아서 사용 (0001 또는 다른 코드).

### 옵션 3: 두 값 모두 표시

당일 수익률과 가중 평균 수익률을 모두 표시하여 투명성 확보.

## 권장 사항

**당일 수익률이 2% 이상일 때는 가중 평균 대신 당일 수익률을 사용**하는 것이 더 정확할 수 있습니다. 큰 변동일 때는 당일 상황이 더 중요하기 때문입니다.

