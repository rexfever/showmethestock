# OHLCV 캐시 시간대 문제 해결

## 문제점

### 기존 문제
- **15시 30분 조회**: 장 마감 직후 데이터 캐싱 (TTL: 24시간)
- **20시 재조회**: 같은 캐시 사용 (15시 30분 데이터)
- **문제**: 15시와 20시가 같은 날이지만 데이터가 다를 수 있음

### 시나리오
```
15:30: get_ohlcv("005930", 220, None)
  → 조회: 2025-11-24 데이터 (장 마감 직후)
  → 캐시 저장 (TTL: 24시간)

20:00: get_ohlcv("005930", 220, None)
  → 캐시 확인: 같은 캐시 키 사용
  → 15:30 데이터 반환
  → 문제: 20시에 데이터가 업데이트되었을 수 있음
```

## 해결 방안

### 1. 장중 vs 장 마감 후 구분

**장중 (09:00 ~ 15:30)**:
- 시간대별 캐시 키 구분 (10분 단위)
- 실시간성 필요 → 짧은 TTL (1분)

**장 마감 후 (15:30 이후)**:
- 당일로 통합 캐싱
- 데이터 변경 없음 → 다음 거래일까지 캐싱

### 2. TTL 개선

**기존**: 24시간 고정
**개선**: 다음 거래일 시작 전까지

```python
def _get_ttl_until_next_trading_day(self) -> int:
    """다음 거래일 시작 전까지의 TTL 계산"""
    # 다음 거래일 09:00까지의 시간 계산
    # 주말과 공휴일 제외
    # 최소 1시간, 최대 72시간
```

## 구현 내용

### 캐시 키 구조 변경

**기존**:
```python
cache_key = (code, count, base_dt)
```

**개선**:
```python
cache_key = (code, count, base_dt, hour_key)
# hour_key: 장중일 때만 시간대 구분, 장 마감 후는 None
```

### TTL 계산 개선

**장중**:
- 시간대별 구분 (10분 단위)
- TTL: 1분

**장 마감 후**:
- 당일로 통합
- TTL: 다음 거래일 09:00까지

**과거 날짜**:
- TTL: 1년

## 동작 예시

### 시나리오 1: 장중 조회

```
09:30: get_ohlcv("005930", 220, None)
  → 캐시 키: ("005930", 220, None, "09:30")
  → TTL: 1분

09:35: get_ohlcv("005930", 220, None)
  → 캐시 키: ("005930", 220, None, "09:30")
  → 캐시에서 반환 (5분 이내)

10:00: get_ohlcv("005930", 220, None)
  → 캐시 키: ("005930", 220, None, "10:00")
  → 다른 시간대 → 캐시 미스 → 재조회
```

### 시나리오 2: 장 마감 후 조회

```
15:30: get_ohlcv("005930", 220, None)
  → 캐시 키: ("005930", 220, None, None)
  → TTL: 다음 거래일 09:00까지

20:00: get_ohlcv("005930", 220, None)
  → 캐시 키: ("005930", 220, None, None)
  → 같은 캐시 사용 ✅
  → 장 마감 후 데이터 변경 없으므로 정상
```

### 시나리오 3: 다음 거래일

```
금요일 15:30: get_ohlcv("005930", 220, None)
  → 캐시 저장
  → TTL: 월요일 09:00까지

월요일 09:01: get_ohlcv("005930", 220, None)
  → 캐시 만료 (다음 거래일 시작)
  → 재조회 → 월요일 데이터
```

## 개선 효과

### Before
- ❌ 15시와 20시 같은 캐시 사용 (데이터 차이 무시)
- ❌ 24시간 고정 TTL (비효율적)

### After
- ✅ 장중: 시간대별 구분 (실시간성 보장)
- ✅ 장 마감 후: 당일 통합 (데이터 변경 없음)
- ✅ 다음 거래일까지 정확한 TTL 계산

## 결론

**핵심 개선**:
1. 장중과 장 마감 후 구분
2. 다음 거래일까지 정확한 TTL 계산
3. 시간대별 캐시 키 구분 (장중만)

**결과**:
- 15시와 20시 조회 시 장 마감 후이므로 같은 캐시 사용 (정상)
- 장중에는 시간대별 구분으로 실시간성 보장
- 다음 거래일까지 정확한 캐싱

