# OHLCV 캐시 애프터마켓 고려 개선

## 문제점

### 기존 가정 (잘못됨)
- 장 마감 후(15:30 이후)에는 데이터가 변경되지 않는다고 가정
- 15시와 20시에 같은 캐시 사용

### 실제 상황
- **애프터마켓**: 오전 8시 ~ 오후 8시까지 주가가 변동
  - 08:00 ~ 09:00: 장전 시간외 거래
  - 09:00 ~ 15:30: 정규 장중
  - 15:30 ~ 20:00: 장후 시간외 거래
- **20:00 ~ 08:00**: 주가 변동 없음

## 해결 방안

### 캐싱 전략 변경

**기존**:
- 장중: 시간대별 구분
- 장 마감 후: 당일로 통합

**개선**:
- **08:00 ~ 20:00**: 시간대별 구분 (10분 단위)
  - 애프터마켓 포함, 주가 변동 가능
  - TTL: 1분
- **20:00 ~ 08:00**: 당일로 통합
  - 데이터 변경 없음
  - TTL: 다음 거래일 09:00까지

## 구현 내용

### 캐시 키 생성

```python
def _get_cache_key(self, code: str, count: int, base_dt: Optional[str]):
    if base_dt is None:
        hour = now.hour
        
        # 08:00 ~ 20:00: 시간대별 구분
        if 8 <= hour < 20:
            hour_key = f"{hour:02d}:{minute // 10 * 10:02d}"  # 10분 단위
            return (code, count, base_dt, hour_key)
        # 20:00 ~ 08:00: 당일로 통합
        else:
            return (code, count, base_dt, None)
```

### TTL 계산

```python
def _calculate_ttl(self, base_dt: Optional[str]) -> int:
    hour = now.hour
    
    # 08:00 ~ 20:00: 애프터마켓 포함, 주가 변동 가능
    if 8 <= hour < 20:
        return 60  # 1분
    # 20:00 ~ 08:00: 데이터 변경 없음
    else:
        return self._get_ttl_until_next_trading_day()
```

## 시나리오별 동작

### 시나리오 1: 08:00 조회

```
08:00: get_ohlcv("005930", 220, None)
  → 캐시 키: ("005930", 220, None, "08:00")
  → TTL: 1분
  → 장전 시간외 거래 데이터
```

### 시나리오 2: 15:30 조회

```
15:30: get_ohlcv("005930", 220, None)
  → 캐시 키: ("005930", 220, None, "15:30")
  → TTL: 1분
  → 장 마감 직후 데이터
```

### 시나리오 3: 16:00 재조회

```
16:00: get_ohlcv("005930", 220, None)
  → 캐시 키: ("005930", 220, None, "16:00")
  → 다른 시간대 → 캐시 미스 → 재조회
  → 장후 시간외 거래 데이터 (15:30과 다를 수 있음)
```

### 시나리오 4: 20:00 조회

```
20:00: get_ohlcv("005930", 220, None)
  → 캐시 키: ("005930", 220, None, None)
  → TTL: 다음 거래일 09:00까지
  → 시간외 종료, 데이터 고정
```

### 시나리오 5: 22:00 재조회

```
22:00: get_ohlcv("005930", 220, None)
  → 캐시 키: ("005930", 220, None, None)
  → 같은 캐시 사용 (20:00과 동일)
  → 데이터 변경 없음
```

## 개선 효과

### Before
- ❌ 15:30과 20:00 같은 캐시 사용
- ❌ 장후 시간외 거래 데이터 변경 무시

### After
- ✅ 08:00 ~ 20:00 시간대별 구분
- ✅ 애프터마켓 주가 변동 반영
- ✅ 20:00 이후 데이터 고정

## 결론

**핵심 개선**:
1. 애프터마켓 시간대(08:00 ~ 20:00) 고려
2. 시간대별 캐시 키 구분 (10분 단위)
3. 20:00 이후 데이터 고정 반영

**결과**:
- 15:30과 16:00: 다른 캐시 사용 (장후 시간외 거래 반영)
- 20:00 이후: 같은 캐시 사용 (데이터 변경 없음)
- 애프터마켓 주가 변동 정확히 반영

