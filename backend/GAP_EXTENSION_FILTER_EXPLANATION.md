# 갭/이격 필터 상세 설명

## 📊 갭 필터 (Gap Filter)

### 정의
**갭(Gap)**은 두 이동평균선(TEMA20과 DEMA10) 사이의 거리를 의미합니다.

### 계산 공식
```python
gap_now = (TEMA20 - DEMA10) / close
```

### 의미
- **TEMA20**: 20일 지수이동평균 (장기선)
- **DEMA10**: 10일 이중지수이동평균 (단기선)
- **gap_now**: 두 선 사이의 거리를 현재가로 나눈 비율

### 해석
- **gap_now > 0**: TEMA20이 DEMA10보다 위에 있음 (정상적인 골든크로스 상태)
- **gap_now < 0**: TEMA20이 DEMA10보다 아래에 있음 (데드크로스 상태, 제외)
- **gap_now가 크면**: 두 선 사이의 거리가 멀어서 추세가 강함
- **gap_now가 작으면**: 두 선이 가까워서 추세가 약함

### 필터 조건
```python
gap_min <= gap_now <= gap_max
```

**현재 설정:**
- `gap_min: 0.2%` (최소 갭)
- `gap_max: 1.8%` (최대 갭, 시장 상황에 따라 조정됨)

**의미:**
- 갭이 0.2% 미만이면: 두 선이 너무 가까워서 추세가 불명확 → 제외
- 갭이 1.8% 초과면: 두 선이 너무 멀어서 이미 상승 추세가 진행됨 → 제외 (추격 방지)

## 📈 이격 필터 (Extension Filter)

### 정의
**이격(Extension)**은 현재가가 TEMA20에서 얼마나 멀리 떨어져 있는지를 의미합니다.

### 계산 공식
```python
ext_pct = (close - TEMA20) / TEMA20
```

### 의미
- **close**: 현재가
- **TEMA20**: 20일 지수이동평균
- **ext_pct**: 현재가가 TEMA20에서 떨어진 비율

### 해석
- **ext_pct > 0**: 현재가가 TEMA20보다 위에 있음 (상승 추세)
- **ext_pct < 0**: 현재가가 TEMA20보다 아래에 있음 (하락 추세, 제외 가능)
- **ext_pct가 크면**: 현재가가 TEMA20에서 많이 떨어져 있음 (과매수 가능성)
- **ext_pct가 작으면**: 현재가가 TEMA20에 가까움 (적정 수준)

### 필터 조건
```python
ext_pct <= ext_from_tema20_max
```

**현재 설정:**
- `ext_from_tema20_max: 1.8%` (최대 이격, 시장 상황에 따라 조정됨)

**의미:**
- 이격이 1.8% 초과면: 현재가가 TEMA20에서 너무 멀어서 과매수 상태 → 제외 (추격 방지)

## 🎯 필터의 목적

### 1. 추격 방지 (Chase Prevention)
- 이미 많이 오른 종목을 추격하지 않기 위함
- 갭이나 이격이 너무 크면 이미 상승 추세가 진행된 상태
- 이런 종목은 매수 타이밍을 놓쳤을 가능성이 높음

### 2. 노이즈 제거 (Noise Filtering)
- 갭이 너무 작으면 두 선이 교차하는 중이거나 추세가 불명확
- 이런 종목은 신호가 약하거나 노이즈일 가능성이 높음

### 3. 적정 진입 시점 포착
- 갭과 이격이 적정 범위 내에 있는 종목만 선택
- 상승 초입 단계의 종목을 찾기 위함

## 📊 필터 작동 예시

### 예시 1: 통과하는 경우
```
현재가: 10,000원
TEMA20: 9,900원
DEMA10: 9,850원

gap_now = (9,900 - 9,850) / 10,000 = 0.005 = 0.5%
ext_pct = (10,000 - 9,900) / 9,900 = 0.0101 = 1.01%

조건 체크:
- gap_now (0.5%) >= gap_min (0.2%) ✅
- gap_now (0.5%) <= gap_max (1.8%) ✅
- ext_pct (1.01%) <= ext_from_tema20_max (1.8%) ✅

→ 통과
```

### 예시 2: 갭 초과로 제외되는 경우
```
현재가: 10,000원
TEMA20: 9,700원
DEMA10: 9,500원

gap_now = (9,700 - 9,500) / 10,000 = 0.02 = 2.0%
ext_pct = (10,000 - 9,700) / 9,700 = 0.0309 = 3.09%

조건 체크:
- gap_now (2.0%) <= gap_max (1.8%) ❌

→ 제외 (갭 초과)
```

### 예시 3: 이격 초과로 제외되는 경우
```
현재가: 10,200원
TEMA20: 9,900원
DEMA10: 9,850원

gap_now = (9,900 - 9,850) / 10,200 = 0.0049 = 0.49%
ext_pct = (10,200 - 9,900) / 9,900 = 0.0303 = 3.03%

조건 체크:
- gap_now (0.49%) >= gap_min (0.2%) ✅
- gap_now (0.49%) <= gap_max (1.8%) ✅
- ext_pct (3.03%) <= ext_from_tema20_max (1.8%) ❌

→ 제외 (이격 초과)
```

## ⚠️ 현재 문제점

### 설정이 너무 엄격함
- `gap_max: 1.8%` (시장 상황에 따라 조정됨)
- `ext_from_tema20_max: 1.8%` (시장 상황에 따라 조정됨)

**문제:**
- 정상적인 시장 움직임도 제외될 수 있음
- 특히 변동성이 큰 종목이나 급등 종목은 대부분 제외됨
- 11월 17일 스캔에서 0개가 나온 원인일 가능성이 높음

### 개선 방안
1. **갭/이격 범위 완화**
   - `gap_max: 1.8%` → `2.5%`
   - `ext_from_tema20_max: 1.8%` → `2.5%`

2. **시장 상황별 동적 조정**
   - 변동성이 큰 시장에서는 범위를 더 넓게
   - 안정적인 시장에서는 범위를 좁게

3. **Fallback에서 완화**
   - Step 0에서는 엄격하게
   - Step 3 이상에서는 범위를 넓게

## 📝 요약

### 갭 필터
- **목적**: TEMA20과 DEMA10 사이의 거리 확인
- **의미**: 골든크로스 상태의 강도 측정
- **제외 조건**: 갭이 너무 작거나 너무 큼

### 이격 필터
- **목적**: 현재가가 TEMA20에서 떨어진 거리 확인
- **의미**: 과매수 상태 여부 측정
- **제외 조건**: 이격이 너무 큼 (추격 방지)

### 현재 설정
- 갭 최대: 1.8%
- 이격 최대: 1.8%
- **너무 엄격하여 많은 종목이 제외되고 있음**

