# 하드 필터 분석

## 하드 필터란?

**하드 필터(Hard Filter)**는 조건을 만족하지 않으면 **즉시 제외**되는 필터입니다.

### 특징:
1. **절대적 제외**: 조건을 만족하지 않으면 더 이상 진행하지 않고 바로 제외
2. **Fallback 불가**: Fallback 로직에도 영향을 주지 않음 (조건을 만족하지 않으면 아예 매칭되지 않음)
3. **점수 계산 전 제외**: 점수 계산 전에 먼저 체크하여 불필요한 계산을 방지

### 왜 "하드" 필터라고 부르나?

- **Hard = 강제적, 절대적**: 조건을 만족하지 않으면 절대 통과할 수 없음
- **Soft Filter와 대비**: 소프트 필터는 점수에만 반영되거나 Fallback 시 완화될 수 있지만, 하드 필터는 절대적

## 현재 하드 필터 목록

### `match_stats` 함수 (매칭 단계)

1. **데이터 길이 필터**
   - 조건: `len(df) < 21`
   - 제외: `return False, 0, 4`
   - 위치: 함수 시작 부분

2. **유동성 필터**
   - 조건: `avg_turnover < config.min_turnover_krw`
   - 제외: `return False, 0, 4`
   - 위치: 라인 104-105
   - 설명: 최근 20일 평균 거래대금이 최소값 미만

3. **가격 필터**
   - 조건: `cur.close < config.min_price`
   - 제외: `return False, 0, 4`
   - 위치: 라인 108-109
   - 설명: 현재가가 최소 가격 미만

4. **과열 필터** (하드 제외)
   - 조건: `RSI_TEMA >= 70 AND volume >= 3.0 * VOL_MA5`
   - 제외: `return False, 0, 4` (즉시 제외)
   - 위치: 라인 116-122
   - 설명: RSI가 70 이상이고 거래량이 평균의 3배 이상

5. **갭/이격 필터**
   - 조건: `gap_now < gap_min OR gap_now > gap_max OR ext_pct > ext_from_tema20_max`
   - 제외: `return False, 0, 4`
   - 위치: 라인 124-128
   - 설명: TEMA20-DEMA10 갭 또는 TEMA20 이격이 범위를 벗어남

6. **ATR 필터** (변동성 필터)
   - 조건: `atr_pct < atr_pct_min OR atr_pct > atr_pct_max` (use_atr_filter가 True일 때)
   - 제외: `return False, 0, 4`
   - 위치: 라인 130-136
   - 설명: 변동성이 너무 낮거나 너무 높음

### `score_conditions` 함수 (점수 계산 단계)

동일한 하드 필터들이 점수 계산 전에 다시 체크됩니다:

1. **유동성 필터** (라인 240-248)
2. **가격 필터** (라인 250-257)
3. **과열 필터** (라인 259-271)
4. **갭/이격 필터** (라인 273-286)
5. **ATR 필터** (라인 288-300)
6. **위험도 필터** (라인 302-313)
   - 조건: `risk_score >= config.risk_score_threshold`
   - 제외: `return 0, {match: False, label: "위험종목"}`

### `scan_one_symbol` 함수 (스캔 시작 단계)

7. **인버스 ETF 필터**
   - 조건: 종목명에 인버스 ETF 키워드 포함
   - 제외: `return None`
   - 위치: 라인 534-536

8. **금리/채권 ETF 필터**
   - 조건: 종목명에 금리/채권 ETF 키워드 포함
   - 제외: `return None`
   - 위치: 라인 538-540

9. **RSI 상한선 필터**
   - 조건: `RSI_TEMA > config.rsi_upper_limit` (기본값 70)
   - 제외: `return None`
   - 위치: 라인 561-564

## 하드 필터 총 개수

**총 9개 하드 필터** (중복 제외 시 6개 고유 필터)

### 고유 필터:
1. 데이터 길이 필터
2. 유동성 필터
3. 가격 필터
4. 과열 필터
5. 갭/이격 필터
6. ATR 필터
7. 위험도 필터 (score_conditions에만)
8. 인버스 ETF 필터
9. 금리/채권 ETF 필터
10. RSI 상한선 필터

## 하드 필터 vs 소프트 필터

### 하드 필터 (Hard Filter)
- **절대적 제외**: 조건 불만족 시 즉시 제외
- **Fallback 불가**: Fallback 로직에도 영향 없음
- **점수 계산 전 제외**: 불필요한 계산 방지
- 예: 유동성, 가격, 과열, 갭/이격, ATR

### 소프트 필터 (Soft Filter)
- **점수 반영**: 조건 불만족 시 점수만 감점
- **Fallback 가능**: Fallback 로직에서 완화 가능
- **점수 계산 후 판단**: 점수에 따라 포함/제외 결정
- 예: 신호 개수, 거래량 배수, RSI 임계값

## 현재 문제점

**모든 하드 필터를 통과한 종목이 0개**라는 것은:
- 하나 이상의 하드 필터가 너무 엄격하거나
- 여러 하드 필터가 동시에 작용하여 모든 종목을 걸러내고 있음

### 의심되는 필터:
1. **갭/이격 필터**: `gap_max: 1.8%`, `ext_from_tema20_max: 1.8%` (너무 좁음)
2. **유동성 필터**: `min_turnover_krw` (서버 설정 확인 필요)
3. **ATR 필터**: `atr_pct_min: 1%`, `atr_pct_max: 4%` (범위가 좁을 수 있음)

