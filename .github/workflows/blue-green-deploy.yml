name: Blue-Green Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment (blue or green)'
        required: false
        default: 'auto'
        type: choice
        options:
        - auto
        - blue
        - green

env:
  DEPLOYMENT_TIMEOUT: 600  # 10ë¶„
  HEALTH_CHECK_RETRIES: 10
  HEALTH_CHECK_INTERVAL: 30

jobs:
  # 1. ì‚¬ì „ ê²€ì¦
  pre-deployment:
    runs-on: ubuntu-latest
    outputs:
      target-env: ${{ steps.determine-env.outputs.target-env }}
      current-env: ${{ steps.determine-env.outputs.current-env }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Determine target environment
      id: determine-env
      run: |
        if [ "${{ github.event.inputs.environment }}" = "auto" ] || [ -z "${{ github.event.inputs.environment }}" ]; then
          echo "ğŸ” í˜„ì¬ í™˜ê²½ í™•ì¸ ì¤‘..."
          
          # í˜„ì¬ í™˜ê²½ í™•ì¸
          CURRENT_ENV=$(ssh -o StrictHostKeyChecking=no -i ${{ secrets.EC2_SSH_KEY }} ubuntu@${{ secrets.EC2_HOST }} '
            if curl -s http://localhost:8010/health > /dev/null 2>&1; then
              echo "blue"
            elif curl -s http://localhost:8011/health > /dev/null 2>&1; then
              echo "green"
            else
              echo "none"
            fi
          ')
          
          if [ "$CURRENT_ENV" = "blue" ]; then
            TARGET_ENV="green"
          elif [ "$CURRENT_ENV" = "green" ]; then
            TARGET_ENV="blue"
          else
            TARGET_ENV="blue"  # ì²« ë°°í¬ì¸ ê²½ìš° blueë¡œ ì‹œì‘
          fi
        else
          TARGET_ENV="${{ github.event.inputs.environment }}"
          CURRENT_ENV="unknown"
        fi
        
        echo "target-env=$TARGET_ENV" >> $GITHUB_OUTPUT
        echo "current-env=$CURRENT_ENV" >> $GITHUB_OUTPUT
        
        echo "ğŸ¯ ë°°í¬ ëŒ€ìƒ í™˜ê²½: $TARGET_ENV"
        echo "ğŸ“ í˜„ì¬ í™˜ê²½: $CURRENT_ENV"
    
    - name: Validate deployment readiness
      run: |
        echo "ğŸ” ë°°í¬ ì¤€ë¹„ ìƒíƒœ í™•ì¸ ì¤‘..."
        
        # ì„œë²„ ì—°ê²° í™•ì¸
        ssh -o StrictHostKeyChecking=no -i ${{ secrets.EC2_SSH_KEY }} ubuntu@${{ secrets.EC2_HOST }} '
          echo "âœ… ì„œë²„ ì—°ê²° ì„±ê³µ"
          
          # ë””ìŠ¤í¬ ê³µê°„ í™•ì¸
          DISK_USAGE=$(df /home/ubuntu | tail -1 | awk "{print \$5}" | sed "s/%//")
          if [ $DISK_USAGE -gt 90 ]; then
            echo "âŒ ë””ìŠ¤í¬ ê³µê°„ ë¶€ì¡±: ${DISK_USAGE}%"
            exit 1
          fi
          echo "âœ… ë””ìŠ¤í¬ ê³µê°„ ì¶©ë¶„: ${DISK_USAGE}%"
          
          # ë©”ëª¨ë¦¬ í™•ì¸
          MEMORY_USAGE=$(free | grep Mem | awk "{printf \"%.0f\", \$3/\$2 * 100.0}")
          if [ $MEMORY_USAGE -gt 90 ]; then
            echo "âš ï¸ ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  ë†’ìŒ: ${MEMORY_USAGE}%"
          else
            echo "âœ… ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  ì •ìƒ: ${MEMORY_USAGE}%"
          fi
        '

  # 2. ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…
  backup-database:
    runs-on: ubuntu-latest
    needs: pre-deployment
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Backup databases
      run: |
        echo "ğŸ’¾ ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ì‹œì‘..."
        
        ssh -o StrictHostKeyChecking=no -i ${{ secrets.EC2_SSH_KEY }} ubuntu@${{ secrets.EC2_HOST }} '
          cd /home/ubuntu/showmethestock
          
          # ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p /home/ubuntu/backups/db
          
          # DB íŒŒì¼ë“¤ ë°±ì—…
          DB_FILES=("snapshots.db" "portfolio.db" "email_verifications.db" "news_data.db")
          BACKUP_TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          
          for db_file in "${DB_FILES[@]}"; do
            if [ -f "backend/$db_file" ]; then
              cp "backend/$db_file" "/home/ubuntu/backups/db/${db_file}.backup.${BACKUP_TIMESTAMP}"
              echo "âœ… ë°±ì—… ì™„ë£Œ: $db_file"
            else
              echo "âš ï¸ DB íŒŒì¼ ì—†ìŒ: $db_file"
            fi
          done
          
          echo "ğŸ‰ ëª¨ë“  ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ì™„ë£Œ"
        '

  # 3. Blue-Green ë°°í¬
  blue-green-deploy:
    runs-on: ubuntu-latest
    needs: [pre-deployment, backup-database]
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Blue-Green Deployment
      run: |
        echo "ğŸš€ Blue-Green ë°°í¬ ì‹œì‘..."
        echo "ëŒ€ìƒ í™˜ê²½: ${{ needs.pre-deployment.outputs.target-env }}"
        echo "í˜„ì¬ í™˜ê²½: ${{ needs.pre-deployment.outputs.current-env }}"
        
        ssh -o StrictHostKeyChecking=no -i ${{ secrets.EC2_SSH_KEY }} ubuntu@${{ secrets.EC2_HOST }} '
          set -e
          
          TARGET_ENV="${{ needs.pre-deployment.outputs.target-env }}"
          CURRENT_ENV="${{ needs.pre-deployment.outputs.current-env }}"
          
          # í¬íŠ¸ ì„¤ì •
          if [ "$TARGET_ENV" = "blue" ]; then
            BACKEND_PORT=8010
            FRONTEND_PORT=3000
          else
            BACKEND_PORT=8011
            FRONTEND_PORT=3001
          fi
          
          echo "ğŸ¯ ë°°í¬ í¬íŠ¸ ì„¤ì •:"
          echo "  ë°±ì—”ë“œ: $BACKEND_PORT"
          echo "  í”„ë¡ íŠ¸ì—”ë“œ: $FRONTEND_PORT"
          
          cd /home/ubuntu/showmethestock
          
          # 1. ì½”ë“œ ì—…ë°ì´íŠ¸
          echo "ğŸ”„ ì½”ë“œ ì—…ë°ì´íŠ¸ ì¤‘..."
          git fetch origin
          git reset --hard origin/main
          
          # 2. ë°±ì—”ë“œ ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„±
          echo "ğŸ“ ë°±ì—”ë“œ ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„± ì¤‘..."
          sudo tee /etc/systemd/system/stock-finder-backend-$TARGET_ENV.service > /dev/null << EOF
        [Unit]
        Description=Stock Finder Backend API ($TARGET_ENV)
        After=network.target
        Wants=network.target

        [Service]
        Type=simple
        User=ubuntu
        Group=ubuntu
        WorkingDirectory=/home/ubuntu/showmethestock/backend
        Environment=PATH=/home/ubuntu/showmethestock/backend/venv/bin
        Environment=PYTHONPATH=/home/ubuntu/showmethestock
        ExecStart=/home/ubuntu/showmethestock/backend/venv/bin/uvicorn main:app --host 0.0.0.0 --port $BACKEND_PORT --workers 1
        ExecReload=/bin/kill -HUP \$MAINPID
        Restart=always
        RestartSec=10
        StandardOutput=journal
        StandardError=journal
        SyslogIdentifier=stock-finder-backend-$TARGET_ENV

        [Install]
        WantedBy=multi-user.target
        EOF
          
          # 3. ë°±ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜ ë° ì„œë¹„ìŠ¤ ì‹œì‘
          echo "ğŸ ë°±ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
          cd backend
          source venv/bin/activate
          pip install -r requirements.txt --quiet
          
          echo "ğŸš€ ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘..."
          sudo systemctl daemon-reload
          sudo systemctl start stock-finder-backend-$TARGET_ENV
          sudo systemctl enable stock-finder-backend-$TARGET_ENV
          
          # 4. ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬
          echo "ğŸ¥ ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬ ì¤‘..."
          for i in {1..30}; do
            if curl -s -f http://localhost:$BACKEND_PORT/health > /dev/null 2>&1; then
              echo "âœ… ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì •ìƒ ì‹œì‘"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì‹œì‘ ì‹¤íŒ¨"
              sudo systemctl stop stock-finder-backend-$TARGET_ENV
              exit 1
            fi
            sleep 2
          done
          
          # 5. í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„±
          echo "ğŸ“ í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„± ì¤‘..."
          sudo tee /etc/systemd/system/stock-finder-frontend-$TARGET_ENV.service > /dev/null << EOF
        [Unit]
        Description=Stock Finder Frontend ($TARGET_ENV)
        After=network.target
        Wants=network.target

        [Service]
        Type=simple
        User=ubuntu
        Group=ubuntu
        WorkingDirectory=/home/ubuntu/showmethestock/frontend
        Environment=NODE_ENV=production
        Environment=PORT=$FRONTEND_PORT
        ExecStart=/usr/bin/npm start
        Restart=always
        RestartSec=10
        StandardOutput=journal
        StandardError=journal
        SyslogIdentifier=stock-finder-frontend-$TARGET_ENV

        [Install]
        WantedBy=multi-user.target
        EOF
          
          # 6. í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ë° ì„œë¹„ìŠ¤ ì‹œì‘
          echo "ğŸ“¦ í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
          cd ../frontend
          npm ci --production=false
          
          echo "ğŸ”¨ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì¤‘..."
          rm -rf .next
          npm run build
          
          echo "ğŸš€ í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘..."
          sudo systemctl daemon-reload
          sudo systemctl start stock-finder-frontend-$TARGET_ENV
          sudo systemctl enable stock-finder-frontend-$TARGET_ENV
          
          # 7. í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ì²´í¬
          echo "ğŸ¥ í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ì²´í¬ ì¤‘..."
          for i in {1..30}; do
            if curl -s -f http://localhost:$FRONTEND_PORT > /dev/null 2>&1; then
              echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ ì •ìƒ ì‹œì‘"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ ì‹œì‘ ì‹¤íŒ¨"
              sudo systemctl stop stock-finder-frontend-$TARGET_ENV
              sudo systemctl stop stock-finder-backend-$TARGET_ENV
              exit 1
            fi
            sleep 2
          done
          
          echo "ğŸ‰ ìƒˆ í™˜ê²½ ($TARGET_ENV) ë°°í¬ ì™„ë£Œ!"
        '

  # 4. íŠ¸ë˜í”½ ì „í™˜
  traffic-switch:
    runs-on: ubuntu-latest
    needs: [pre-deployment, blue-green-deploy]
    timeout-minutes: 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Switch traffic to new environment
      run: |
        echo "ğŸ”„ íŠ¸ë˜í”½ ì „í™˜ ì‹œì‘..."
        
        ssh -o StrictHostKeyChecking=no -i ${{ secrets.EC2_SSH_KEY }} ubuntu@${{ secrets.EC2_HOST }} '
          set -e
          
          TARGET_ENV="${{ needs.pre-deployment.outputs.target-env }}"
          CURRENT_ENV="${{ needs.pre-deployment.outputs.current-env }}"
          
          # í¬íŠ¸ ì„¤ì •
          if [ "$TARGET_ENV" = "blue" ]; then
            BACKEND_PORT=8010
            FRONTEND_PORT=3000
          else
            BACKEND_PORT=8011
            FRONTEND_PORT=3001
          fi
          
          echo "ğŸ¯ íŠ¸ë˜í”½ ì „í™˜ ëŒ€ìƒ: $TARGET_ENV (í¬íŠ¸: $BACKEND_PORT, $FRONTEND_PORT)"
          
          # Nginx ì„¤ì • ë°±ì—…
          sudo cp /etc/nginx/sites-available/stock-finder /etc/nginx/sites-available/stock-finder.backup.$(date +%Y%m%d_%H%M%S)
          
          # ìƒˆ í™˜ê²½ìœ¼ë¡œ Nginx ì„¤ì • ì—…ë°ì´íŠ¸
          echo "ğŸ“ Nginx ì„¤ì • ì—…ë°ì´íŠ¸ ì¤‘..."
          sudo tee /etc/nginx/sites-available/stock-finder > /dev/null << EOF
        server {
            listen 80;
            server_name sohntech.ai.kr;

            # í”„ë¡ íŠ¸ì—”ë“œ í”„ë¡ì‹œ
            location / {
                proxy_pass http://localhost:$FRONTEND_PORT;
                proxy_http_version 1.1;
                proxy_set_header Upgrade \$http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_set_header Host \$host;
                proxy_set_header X-Real-IP \$remote_addr;
                proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto \$scheme;
                proxy_cache_bypass \$http_upgrade;
            }

            # ë°±ì—”ë“œ API í”„ë¡ì‹œ
            location /api/ {
                proxy_pass http://localhost:$BACKEND_PORT/;
                proxy_http_version 1.1;
                proxy_set_header Upgrade \$http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_set_header Host \$host;
                proxy_set_header X-Real-IP \$remote_addr;
                proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto \$scheme;
                proxy_cache_bypass \$http_upgrade;
            }

            # ë¡œê·¸ ì„¤ì •
            access_log /var/log/nginx/stock-finder.access.log;
            error_log /var/log/nginx/stock-finder.error.log;
        }
        EOF
          
          # Nginx ì„¤ì • ê²€ì¦
          if sudo nginx -t; then
            echo "âœ… Nginx ì„¤ì • ê²€ì¦ ì™„ë£Œ"
          else
            echo "âŒ Nginx ì„¤ì • ì˜¤ë¥˜"
            # ë°±ì—… ë³µì›
            sudo cp /etc/nginx/sites-available/stock-finder.backup.$(date +%Y%m%d_%H%M%S) /etc/nginx/sites-available/stock-finder
            exit 1
          fi
          
          # Nginx ì¬ì‹œì‘
          echo "ğŸ”„ Nginx ì¬ì‹œì‘ ì¤‘..."
          sudo systemctl reload nginx
          
          # ìµœì¢… í—¬ìŠ¤ì²´í¬
          echo "ğŸ¥ ìµœì¢… í—¬ìŠ¤ì²´í¬ ì¤‘..."
          sleep 5
          
          if curl -s -f http://sohntech.ai.kr > /dev/null 2>&1; then
            echo "âœ… íŠ¸ë˜í”½ ì „í™˜ ì„±ê³µ"
          else
            echo "âŒ íŠ¸ë˜í”½ ì „í™˜ ì‹¤íŒ¨"
            # ë¡¤ë°±
            sudo cp /etc/nginx/sites-available/stock-finder.backup.$(date +%Y%m%d_%H%M%S) /etc/nginx/sites-available/stock-finder
            sudo systemctl reload nginx
            exit 1
          fi
          
          echo "ğŸ‰ íŠ¸ë˜í”½ ì „í™˜ ì™„ë£Œ!"
        '

  # 5. ì´ì „ í™˜ê²½ ì •ë¦¬
  cleanup:
    runs-on: ubuntu-latest
    needs: [pre-deployment, traffic-switch]
    if: always() && needs.traffic-switch.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Cleanup previous environment
      run: |
        echo "ğŸ§¹ ì´ì „ í™˜ê²½ ì •ë¦¬ ì‹œì‘..."
        
        ssh -o StrictHostKeyChecking=no -i ${{ secrets.EC2_SSH_KEY }} ubuntu@${{ secrets.EC2_HOST }} '
          CURRENT_ENV="${{ needs.pre-deployment.outputs.current-env }}"
          
          if [ "$CURRENT_ENV" != "none" ] && [ "$CURRENT_ENV" != "unknown" ]; then
            echo "ğŸ›‘ ì´ì „ í™˜ê²½ ($CURRENT_ENV) ì„œë¹„ìŠ¤ ì¤‘ì§€ ì¤‘..."
            
            sudo systemctl stop stock-finder-backend-$CURRENT_ENV || true
            sudo systemctl stop stock-finder-frontend-$CURRENT_ENV || true
            sudo systemctl disable stock-finder-backend-$CURRENT_ENV || true
            sudo systemctl disable stock-finder-frontend-$CURRENT_ENV || true
            
            echo "âœ… ì´ì „ í™˜ê²½ ì •ë¦¬ ì™„ë£Œ"
          else
            echo "â„¹ï¸ ì •ë¦¬í•  ì´ì „ í™˜ê²½ì´ ì—†ìŠµë‹ˆë‹¤"
          fi
        '

  # 6. ë°°í¬ í›„ ê²€ì¦
  post-deployment:
    runs-on: ubuntu-latest
    needs: [pre-deployment, traffic-switch, cleanup]
    if: always() && needs.traffic-switch.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Post-deployment verification
      run: |
        echo "ğŸ” ë°°í¬ í›„ ê²€ì¦ ì‹œì‘..."
        
        ssh -o StrictHostKeyChecking=no -i ${{ secrets.EC2_SSH_KEY }} ubuntu@${{ secrets.EC2_HOST }} '
          TARGET_ENV="${{ needs.pre-deployment.outputs.target-env }}"
          
          echo "ğŸ¯ í˜„ì¬ ìš´ì˜ í™˜ê²½: $TARGET_ENV"
          
          # í¬íŠ¸ ì„¤ì •
          if [ "$TARGET_ENV" = "blue" ]; then
            BACKEND_PORT=8010
            FRONTEND_PORT=3000
          else
            BACKEND_PORT=8011
            FRONTEND_PORT=3001
          fi
          
          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          echo "ğŸ“Š ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸:"
          sudo systemctl status stock-finder-backend-$TARGET_ENV --no-pager -l | head -3
          sudo systemctl status stock-finder-frontend-$TARGET_ENV --no-pager -l | head -3
          
          # í—¬ìŠ¤ì²´í¬
          echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ ì‹¤í–‰:"
          
          # ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬
          if curl -s -f http://localhost:$BACKEND_PORT/health > /dev/null 2>&1; then
            echo "âœ… ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬ í†µê³¼"
          else
            echo "âŒ ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
            exit 1
          fi
          
          # í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ì²´í¬
          if curl -s -f http://localhost:$FRONTEND_PORT > /dev/null 2>&1; then
            echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ì²´í¬ í†µê³¼"
          else
            echo "âŒ í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
            exit 1
          fi
          
          # ì™¸ë¶€ ì ‘ê·¼ í™•ì¸
          if curl -s -f http://sohntech.ai.kr > /dev/null 2>&1; then
            echo "âœ… ì™¸ë¶€ ì ‘ê·¼ í™•ì¸ í†µê³¼"
          else
            echo "âŒ ì™¸ë¶€ ì ‘ê·¼ í™•ì¸ ì‹¤íŒ¨"
            exit 1
          fi
          
          # ì‘ë‹µ ì‹œê°„ ì¸¡ì •
          BACKEND_TIME=$(curl -s -w "%{time_total}" -o /dev/null http://localhost:$BACKEND_PORT/health)
          FRONTEND_TIME=$(curl -s -w "%{time_total}" -o /dev/null http://localhost:$FRONTEND_PORT)
          EXTERNAL_TIME=$(curl -s -w "%{time_total}" -o /dev/null http://sohntech.ai.kr)
          
          echo "â±ï¸ ì‘ë‹µ ì‹œê°„:"
          echo "  ë°±ì—”ë“œ: ${BACKEND_TIME}ì´ˆ"
          echo "  í”„ë¡ íŠ¸ì—”ë“œ: ${FRONTEND_TIME}ì´ˆ"
          echo "  ì™¸ë¶€ ì ‘ê·¼: ${EXTERNAL_TIME}ì´ˆ"
          
          echo "ğŸ‰ ë°°í¬ í›„ ê²€ì¦ ì™„ë£Œ!"
        '

  # 7. ë°°í¬ ì™„ë£Œ ì•Œë¦¼
  notify:
    runs-on: ubuntu-latest
    needs: [pre-deployment, post-deployment]
    if: always()
    
    steps:
    - name: Deployment notification
      run: |
        TARGET_ENV="${{ needs.pre-deployment.outputs.target-env }}"
        DEPLOYMENT_STATUS="${{ needs.post-deployment.result }}"
        
        if [ "$DEPLOYMENT_STATUS" = "success" ]; then
          echo "ğŸ‰ Blue-Green ë°°í¬ ì„±ê³µ!"
          echo "í˜„ì¬ ìš´ì˜ í™˜ê²½: $TARGET_ENV"
          echo "ë‹¤ìš´íƒ€ì„: 0ì´ˆ"
        else
          echo "âŒ Blue-Green ë°°í¬ ì‹¤íŒ¨"
          echo "ë°°í¬ ìƒíƒœ: $DEPLOYMENT_STATUS"
        fi
        
        # ë°°í¬ ì •ë³´ ì €ì¥
        echo "{
          \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
          \"deployment_type\": \"blue-green\",
          \"target_environment\": \"$TARGET_ENV\",
          \"status\": \"$DEPLOYMENT_STATUS\",
          \"downtime_seconds\": 0,
          \"github_workflow\": \"${{ github.workflow }}\",
          \"github_run_id\": \"${{ github.run_id }}\"
        }" > deployment-summary.json
        
        echo "ğŸ“„ ë°°í¬ ìš”ì•½ì´ deployment-summary.jsonì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."
