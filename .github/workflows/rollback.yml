name: Emergency Rollback

on:
  workflow_dispatch:
    inputs:
      target-environment:
        description: 'Target environment to rollback to (blue or green)'
        required: true
        type: choice
        options:
        - blue
        - green
      rollback-reason:
        description: 'Reason for rollback'
        required: true
        type: string

env:
  ROLLBACK_TIMEOUT: 300  # 5ë¶„

jobs:
  # 1. í˜„ì¬ ìƒíƒœ í™•ì¸
  check-current-state:
    runs-on: ubuntu-latest
    outputs:
      current-env: ${{ steps.check-env.outputs.current-env }}
      target-env: ${{ steps.check-env.outputs.target-env }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Check current environment
      id: check-env
      run: |
        echo "ğŸ” í˜„ì¬ í™˜ê²½ ìƒíƒœ í™•ì¸ ì¤‘..."
        
        # í˜„ì¬ í™˜ê²½ í™•ì¸
        CURRENT_ENV=$(ssh -o StrictHostKeyChecking=no -i ${{ secrets.EC2_SSH_KEY }} ubuntu@${{ secrets.EC2_HOST }} '
          if curl -s http://localhost:8010/health > /dev/null 2>&1; then
            echo "blue"
          elif curl -s http://localhost:8011/health > /dev/null 2>&1; then
            echo "green"
          else
            echo "none"
          fi
        ')
        
        TARGET_ENV="${{ github.event.inputs.target-environment }}"
        
        echo "current-env=$CURRENT_ENV" >> $GITHUB_OUTPUT
        echo "target-env=$TARGET_ENV" >> $GITHUB_OUTPUT
        
        echo "ğŸ“ í˜„ì¬ í™˜ê²½: $CURRENT_ENV"
        echo "ğŸ¯ ë¡¤ë°± ëŒ€ìƒ: $TARGET_ENV"
        echo "ğŸ“ ë¡¤ë°± ì‚¬ìœ : ${{ github.event.inputs.rollback-reason }}"
        
        # ë¡¤ë°± ê°€ëŠ¥ì„± í™•ì¸
        if [ "$CURRENT_ENV" = "$TARGET_ENV" ]; then
          echo "âš ï¸ í˜„ì¬ í™˜ê²½ê³¼ ë¡¤ë°± ëŒ€ìƒì´ ë™ì¼í•©ë‹ˆë‹¤."
          echo "ë¡¤ë°±ì´ í•„ìš”í•œì§€ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”."
        fi

  # 2. ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… (í˜„ì¬ ìƒíƒœ)
  backup-current-state:
    runs-on: ubuntu-latest
    needs: check-current-state
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Backup current database state
      run: |
        echo "ğŸ’¾ í˜„ì¬ ìƒíƒœ ë°±ì—… ì¤‘..."
        
        ssh -o StrictHostKeyChecking=no -i ${{ secrets.EC2_SSH_KEY }} ubuntu@${{ secrets.EC2_HOST }} '
          cd /home/ubuntu/showmethestock
          
          # ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p /home/ubuntu/backups/rollback
          
          # ë¡¤ë°± ì „ ë°±ì—…
          ROLLBACK_TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          DB_FILES=("snapshots.db" "portfolio.db" "email_verifications.db" "news_data.db")
          
          for db_file in "${DB_FILES[@]}"; do
            if [ -f "backend/$db_file" ]; then
              cp "backend/$db_file" "/home/ubuntu/backups/rollback/${db_file}.rollback_before.${ROLLBACK_TIMESTAMP}"
              echo "âœ… ë¡¤ë°± ì „ ë°±ì—… ì™„ë£Œ: $db_file"
            fi
          done
          
          echo "ğŸ‰ ë¡¤ë°± ì „ ë°±ì—… ì™„ë£Œ"
        '

  # 3. ë¡¤ë°± ì‹¤í–‰
  execute-rollback:
    runs-on: ubuntu-latest
    needs: [check-current-state, backup-current-state]
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Execute rollback
      run: |
        echo "ğŸ”„ ë¡¤ë°± ì‹¤í–‰ ì‹œì‘..."
        echo "í˜„ì¬ í™˜ê²½: ${{ needs.check-current-state.outputs.current-env }}"
        echo "ë¡¤ë°± ëŒ€ìƒ: ${{ needs.check-current-state.outputs.target-env }}"
        
        ssh -o StrictHostKeyChecking=no -i ${{ secrets.EC2_SSH_KEY }} ubuntu@${{ secrets.EC2_HOST }} '
          set -e
          
          TARGET_ENV="${{ needs.check-current-state.outputs.target-env }}"
          CURRENT_ENV="${{ needs.check-current-state.outputs.current-env }}"
          
          # í¬íŠ¸ ì„¤ì •
          if [ "$TARGET_ENV" = "blue" ]; then
            BACKEND_PORT=8010
            FRONTEND_PORT=3000
          else
            BACKEND_PORT=8011
            FRONTEND_PORT=3001
          fi
          
          echo "ğŸ¯ ë¡¤ë°± í¬íŠ¸ ì„¤ì •:"
          echo "  ë°±ì—”ë“œ: $BACKEND_PORT"
          echo "  í”„ë¡ íŠ¸ì—”ë“œ: $FRONTEND_PORT"
          
          cd /home/ubuntu/showmethestock
          
          # 1. ëŒ€ìƒ í™˜ê²½ ì„œë¹„ìŠ¤ ì‹œì‘
          echo "ğŸš€ ëŒ€ìƒ í™˜ê²½ ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘..."
          
          # ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì‹œì‘
          sudo systemctl start stock-finder-backend-$TARGET_ENV || true
          sudo systemctl enable stock-finder-backend-$TARGET_ENV || true
          
          # í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ ì‹œì‘
          sudo systemctl start stock-finder-frontend-$TARGET_ENV || true
          sudo systemctl enable stock-finder-frontend-$TARGET_ENV || true
          
          # 2. ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸°
          echo "â³ ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
          sleep 10
          
          # 3. ëŒ€ìƒ í™˜ê²½ í—¬ìŠ¤ì²´í¬
          echo "ğŸ¥ ëŒ€ìƒ í™˜ê²½ í—¬ìŠ¤ì²´í¬ ì¤‘..."
          
          # ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬
          for i in {1..30}; do
            if curl -s -f http://localhost:$BACKEND_PORT/health > /dev/null 2>&1; then
              echo "âœ… ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬ í†µê³¼"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
              exit 1
            fi
            sleep 2
          done
          
          # í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ì²´í¬
          for i in {1..30}; do
            if curl -s -f http://localhost:$FRONTEND_PORT > /dev/null 2>&1; then
              echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ì²´í¬ í†µê³¼"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
              exit 1
            fi
            sleep 2
          done
          
          # 4. Nginx ì„¤ì • ì—…ë°ì´íŠ¸
          echo "ğŸ“ Nginx ì„¤ì • ì—…ë°ì´íŠ¸ ì¤‘..."
          
          # Nginx ì„¤ì • ë°±ì—…
          sudo cp /etc/nginx/sites-available/stock-finder /etc/nginx/sites-available/stock-finder.rollback_backup.$(date +%Y%m%d_%H%M%S)
          
          # ë¡¤ë°± ëŒ€ìƒ í™˜ê²½ìœ¼ë¡œ Nginx ì„¤ì • ì—…ë°ì´íŠ¸
          sudo tee /etc/nginx/sites-available/stock-finder > /dev/null << EOF
        server {
            listen 80;
            server_name sohntech.ai.kr;

            # í”„ë¡ íŠ¸ì—”ë“œ í”„ë¡ì‹œ
            location / {
                proxy_pass http://localhost:$FRONTEND_PORT;
                proxy_http_version 1.1;
                proxy_set_header Upgrade \$http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_set_header Host \$host;
                proxy_set_header X-Real-IP \$remote_addr;
                proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto \$scheme;
                proxy_cache_bypass \$http_upgrade;
            }

            # ë°±ì—”ë“œ API í”„ë¡ì‹œ
            location /api/ {
                proxy_pass http://localhost:$BACKEND_PORT/;
                proxy_http_version 1.1;
                proxy_set_header Upgrade \$http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_set_header Host \$host;
                proxy_set_header X-Real-IP \$remote_addr;
                proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto \$scheme;
                proxy_cache_bypass \$http_upgrade;
            }

            # ë¡œê·¸ ì„¤ì •
            access_log /var/log/nginx/stock-finder.access.log;
            error_log /var/log/nginx/stock-finder.error.log;
        }
        EOF
          
          # Nginx ì„¤ì • ê²€ì¦
          if sudo nginx -t; then
            echo "âœ… Nginx ì„¤ì • ê²€ì¦ ì™„ë£Œ"
          else
            echo "âŒ Nginx ì„¤ì • ì˜¤ë¥˜"
            # ë°±ì—… ë³µì›
            sudo cp /etc/nginx/sites-available/stock-finder.rollback_backup.$(date +%Y%m%d_%H%M%S) /etc/nginx/sites-available/stock-finder
            exit 1
          fi
          
          # Nginx ì¬ì‹œì‘
          echo "ğŸ”„ Nginx ì¬ì‹œì‘ ì¤‘..."
          sudo systemctl reload nginx
          
          # 5. ìµœì¢… í™•ì¸
          echo "ğŸ¥ ìµœì¢… í™•ì¸ ì¤‘..."
          sleep 5
          
          if curl -s -f http://sohntech.ai.kr > /dev/null 2>&1; then
            echo "âœ… ë¡¤ë°± ì„±ê³µ"
          else
            echo "âŒ ë¡¤ë°± ì‹¤íŒ¨"
            # ë°±ì—… ë³µì›
            sudo cp /etc/nginx/sites-available/stock-finder.rollback_backup.$(date +%Y%m%d_%H%M%S) /etc/nginx/sites-available/stock-finder
            sudo systemctl reload nginx
            exit 1
          fi
          
          echo "ğŸ‰ ë¡¤ë°± ì™„ë£Œ!"
        '

  # 4. ì´ì „ í™˜ê²½ ì •ë¦¬
  cleanup-previous:
    runs-on: ubuntu-latest
    needs: [check-current-state, execute-rollback]
    if: always() && needs.execute-rollback.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Cleanup previous environment
      run: |
        echo "ğŸ§¹ ì´ì „ í™˜ê²½ ì •ë¦¬ ì‹œì‘..."
        
        ssh -o StrictHostKeyChecking=no -i ${{ secrets.EC2_SSH_KEY }} ubuntu@${{ secrets.EC2_HOST }} '
          CURRENT_ENV="${{ needs.check-current-state.outputs.current-env }}"
          TARGET_ENV="${{ needs.check-current-state.outputs.target-env }}"
          
          if [ "$CURRENT_ENV" != "none" ] && [ "$CURRENT_ENV" != "$TARGET_ENV" ]; then
            echo "ğŸ›‘ ì´ì „ í™˜ê²½ ($CURRENT_ENV) ì„œë¹„ìŠ¤ ì¤‘ì§€ ì¤‘..."
            
            sudo systemctl stop stock-finder-backend-$CURRENT_ENV || true
            sudo systemctl stop stock-finder-frontend-$CURRENT_ENV || true
            sudo systemctl disable stock-finder-backend-$CURRENT_ENV || true
            sudo systemctl disable stock-finder-frontend-$CURRENT_ENV || true
            
            echo "âœ… ì´ì „ í™˜ê²½ ì •ë¦¬ ì™„ë£Œ"
          else
            echo "â„¹ï¸ ì •ë¦¬í•  ì´ì „ í™˜ê²½ì´ ì—†ìŠµë‹ˆë‹¤"
          fi
        '

  # 5. ë¡¤ë°± í›„ ê²€ì¦
  verify-rollback:
    runs-on: ubuntu-latest
    needs: [check-current-state, execute-rollback, cleanup-previous]
    if: always() && needs.execute-rollback.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Verify rollback
      run: |
        echo "ğŸ” ë¡¤ë°± í›„ ê²€ì¦ ì‹œì‘..."
        
        ssh -o StrictHostKeyChecking=no -i ${{ secrets.EC2_SSH_KEY }} ubuntu@${{ secrets.EC2_HOST }} '
          TARGET_ENV="${{ needs.check-current-state.outputs.target-env }}"
          
          echo "ğŸ¯ í˜„ì¬ ìš´ì˜ í™˜ê²½: $TARGET_ENV"
          
          # í¬íŠ¸ ì„¤ì •
          if [ "$TARGET_ENV" = "blue" ]; then
            BACKEND_PORT=8010
            FRONTEND_PORT=3000
          else
            BACKEND_PORT=8011
            FRONTEND_PORT=3001
          fi
          
          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          echo "ğŸ“Š ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸:"
          sudo systemctl status stock-finder-backend-$TARGET_ENV --no-pager -l | head -3
          sudo systemctl status stock-finder-frontend-$TARGET_ENV --no-pager -l | head -3
          
          # í—¬ìŠ¤ì²´í¬
          echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ ì‹¤í–‰:"
          
          # ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬
          if curl -s -f http://localhost:$BACKEND_PORT/health > /dev/null 2>&1; then
            echo "âœ… ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬ í†µê³¼"
          else
            echo "âŒ ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
            exit 1
          fi
          
          # í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ì²´í¬
          if curl -s -f http://localhost:$FRONTEND_PORT > /dev/null 2>&1; then
            echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ì²´í¬ í†µê³¼"
          else
            echo "âŒ í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
            exit 1
          fi
          
          # ì™¸ë¶€ ì ‘ê·¼ í™•ì¸
          if curl -s -f http://sohntech.ai.kr > /dev/null 2>&1; then
            echo "âœ… ì™¸ë¶€ ì ‘ê·¼ í™•ì¸ í†µê³¼"
          else
            echo "âŒ ì™¸ë¶€ ì ‘ê·¼ í™•ì¸ ì‹¤íŒ¨"
            exit 1
          fi
          
          # ì‘ë‹µ ì‹œê°„ ì¸¡ì •
          BACKEND_TIME=$(curl -s -w "%{time_total}" -o /dev/null http://localhost:$BACKEND_PORT/health)
          FRONTEND_TIME=$(curl -s -w "%{time_total}" -o /dev/null http://localhost:$FRONTEND_PORT)
          EXTERNAL_TIME=$(curl -s -w "%{time_total}" -o /dev/null http://sohntech.ai.kr)
          
          echo "â±ï¸ ì‘ë‹µ ì‹œê°„:"
          echo "  ë°±ì—”ë“œ: ${BACKEND_TIME}ì´ˆ"
          echo "  í”„ë¡ íŠ¸ì—”ë“œ: ${FRONTEND_TIME}ì´ˆ"
          echo "  ì™¸ë¶€ ì ‘ê·¼: ${EXTERNAL_TIME}ì´ˆ"
          
          echo "ğŸ‰ ë¡¤ë°± í›„ ê²€ì¦ ì™„ë£Œ!"
        '

  # 6. ë¡¤ë°± ì™„ë£Œ ì•Œë¦¼
  notify-rollback:
    runs-on: ubuntu-latest
    needs: [check-current-state, verify-rollback]
    if: always()
    
    steps:
    - name: Rollback notification
      run: |
        TARGET_ENV="${{ needs.check-current-state.outputs.target-env }}"
        ROLLBACK_STATUS="${{ needs.verify-rollback.result }}"
        ROLLBACK_REASON="${{ github.event.inputs.rollback-reason }}"
        
        if [ "$ROLLBACK_STATUS" = "success" ]; then
          echo "ğŸ‰ ë¡¤ë°± ì„±ê³µ!"
          echo "í˜„ì¬ ìš´ì˜ í™˜ê²½: $TARGET_ENV"
          echo "ë¡¤ë°± ì‚¬ìœ : $ROLLBACK_REASON"
          echo "ë‹¤ìš´íƒ€ì„: ìµœì†Œí™”ë¨"
        else
          echo "âŒ ë¡¤ë°± ì‹¤íŒ¨"
          echo "ë¡¤ë°± ìƒíƒœ: $ROLLBACK_STATUS"
          echo "ë¡¤ë°± ì‚¬ìœ : $ROLLBACK_REASON"
        fi
        
        # ë¡¤ë°± ì •ë³´ ì €ì¥
        echo "{
          \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
          \"action\": \"rollback\",
          \"target_environment\": \"$TARGET_ENV\",
          \"status\": \"$ROLLBACK_STATUS\",
          \"reason\": \"$ROLLBACK_REASON\",
          \"github_workflow\": \"${{ github.workflow }}\",
          \"github_run_id\": \"${{ github.run_id }}\"
        }" > rollback-summary.json
        
        echo "ğŸ“„ ë¡¤ë°± ìš”ì•½ì´ rollback-summary.jsonì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."
