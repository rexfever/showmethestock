name: Health Monitor

on:
  schedule:
    # ë§¤ 5ë¶„ë§ˆë‹¤ ì‹¤í–‰
    - cron: '*/5 * * * *'
  workflow_dispatch:
    inputs:
      check-duration:
        description: 'Health check duration in minutes'
        required: false
        default: '5'
        type: string

env:
  HEALTH_CHECK_INTERVAL: 30  # 30ì´ˆë§ˆë‹¤ ì²´í¬
  MAX_FAILURES: 3           # ìµœëŒ€ ì‹¤íŒ¨ íšŸìˆ˜
  CHECK_DURATION: ${{ github.event.inputs.check-duration || '5' }}

jobs:
  # 1. í˜„ì¬ í™˜ê²½ í™•ì¸
  check-environment:
    runs-on: ubuntu-latest
    outputs:
      current-env: ${{ steps.detect-env.outputs.current-env }}
      backend-port: ${{ steps.detect-env.outputs.backend-port }}
      frontend-port: ${{ steps.detect-env.outputs.frontend-port }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Detect current environment
      id: detect-env
      run: |
        echo "ğŸ” í˜„ì¬ í™˜ê²½ ê°ì§€ ì¤‘..."
        
        # í˜„ì¬ í™˜ê²½ í™•ì¸
        ENV_INFO=$(ssh -o StrictHostKeyChecking=no -i ${{ secrets.EC2_SSH_KEY }} ubuntu@${{ secrets.EC2_HOST }} '
          if curl -s http://localhost:8010/health > /dev/null 2>&1; then
            echo "blue:8010:3000"
          elif curl -s http://localhost:8011/health > /dev/null 2>&1; then
            echo "green:8011:3001"
          else
            echo "none:0:0"
          fi
        ')
        
        CURRENT_ENV=$(echo $ENV_INFO | cut -d: -f1)
        BACKEND_PORT=$(echo $ENV_INFO | cut -d: -f2)
        FRONTEND_PORT=$(echo $ENV_INFO | cut -d: -f3)
        
        echo "current-env=$CURRENT_ENV" >> $GITHUB_OUTPUT
        echo "backend-port=$BACKEND_PORT" >> $GITHUB_OUTPUT
        echo "frontend-port=$FRONTEND_PORT" >> $GITHUB_OUTPUT
        
        echo "ğŸ“ í˜„ì¬ í™˜ê²½: $CURRENT_ENV"
        echo "ğŸ”Œ ë°±ì—”ë“œ í¬íŠ¸: $BACKEND_PORT"
        echo "ğŸ”Œ í”„ë¡ íŠ¸ì—”ë“œ í¬íŠ¸: $FRONTEND_PORT"

  # 2. í—¬ìŠ¤ì²´í¬ ì‹¤í–‰
  health-check:
    runs-on: ubuntu-latest
    needs: check-environment
    if: needs.check-environment.outputs.current-env != 'none'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Run health checks
      run: |
        echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
        echo "í™˜ê²½: ${{ needs.check-environment.outputs.current-env }}"
        echo "ë°±ì—”ë“œ í¬íŠ¸: ${{ needs.check-environment.outputs.backend-port }}"
        echo "í”„ë¡ íŠ¸ì—”ë“œ í¬íŠ¸: ${{ needs.check-environment.outputs.frontend-port }}"
        echo "ì²´í¬ ì§€ì† ì‹œê°„: ${{ env.CHECK_DURATION }}ë¶„"
        
        ssh -o StrictHostKeyChecking=no -i ${{ secrets.EC2_SSH_KEY }} ubuntu@${{ secrets.EC2_HOST }} '
          set -e
          
          CURRENT_ENV="${{ needs.check-environment.outputs.current-env }}"
          BACKEND_PORT="${{ needs.check-environment.outputs.backend-port }}"
          FRONTEND_PORT="${{ needs.check-environment.outputs.frontend-port }}"
          CHECK_DURATION="${{ env.CHECK_DURATION }}"
          HEALTH_CHECK_INTERVAL="${{ env.HEALTH_CHECK_INTERVAL }}"
          MAX_FAILURES="${{ env.MAX_FAILURES }}"
          
          # í—¬ìŠ¤ì²´í¬ í•¨ìˆ˜
          check_backend() {
            if curl -s -f http://localhost:$BACKEND_PORT/health > /dev/null 2>&1; then
              return 0
            else
              return 1
            fi
          }
          
          check_frontend() {
            if curl -s -f http://localhost:$FRONTEND_PORT > /dev/null 2>&1; then
              return 0
            else
              return 1
            fi
          }
          
          check_external() {
            if curl -s -f http://sohntech.ai.kr > /dev/null 2>&1; then
              return 0
            else
              return 1
            fi
          }
          
          # í—¬ìŠ¤ì²´í¬ ì‹¤í–‰
          END_TIME=$(($(date +%s) + CHECK_DURATION * 60))
          FAILURE_COUNT=0
          CHECK_COUNT=0
          
          echo "â° í—¬ìŠ¤ì²´í¬ ì‹œì‘: $(date)"
          echo "â° í—¬ìŠ¤ì²´í¬ ì¢…ë£Œ ì˜ˆì •: $(date -d @$END_TIME)"
          
          while [ $(date +%s) -lt $END_TIME ]; do
            CHECK_COUNT=$((CHECK_COUNT + 1))
            CURRENT_TIME=$(date)
            
            echo "ğŸ” í—¬ìŠ¤ì²´í¬ #$CHECK_COUNT ($CURRENT_TIME)"
            
            # ë°±ì—”ë“œ ì²´í¬
            if check_backend; then
              echo "  âœ… ë°±ì—”ë“œ: ì •ìƒ"
            else
              echo "  âŒ ë°±ì—”ë“œ: ì‹¤íŒ¨"
              FAILURE_COUNT=$((FAILURE_COUNT + 1))
            fi
            
            # í”„ë¡ íŠ¸ì—”ë“œ ì²´í¬
            if check_frontend; then
              echo "  âœ… í”„ë¡ íŠ¸ì—”ë“œ: ì •ìƒ"
            else
              echo "  âŒ í”„ë¡ íŠ¸ì—”ë“œ: ì‹¤íŒ¨"
              FAILURE_COUNT=$((FAILURE_COUNT + 1))
            fi
            
            # ì™¸ë¶€ ì ‘ê·¼ ì²´í¬
            if check_external; then
              echo "  âœ… ì™¸ë¶€ ì ‘ê·¼: ì •ìƒ"
            else
              echo "  âŒ ì™¸ë¶€ ì ‘ê·¼: ì‹¤íŒ¨"
              FAILURE_COUNT=$((FAILURE_COUNT + 1))
            fi
            
            # ì‘ë‹µ ì‹œê°„ ì¸¡ì •
            BACKEND_TIME=$(curl -s -w "%{time_total}" -o /dev/null http://localhost:$BACKEND_PORT/health 2>/dev/null || echo "N/A")
            FRONTEND_TIME=$(curl -s -w "%{time_total}" -o /dev/null http://localhost:$FRONTEND_PORT 2>/dev/null || echo "N/A")
            EXTERNAL_TIME=$(curl -s -w "%{time_total}" -o /dev/null http://sohntech.ai.kr 2>/dev/null || echo "N/A")
            
            echo "  â±ï¸ ì‘ë‹µ ì‹œê°„: ë°±ì—”ë“œ=${BACKEND_TIME}s, í”„ë¡ íŠ¸ì—”ë“œ=${FRONTEND_TIME}s, ì™¸ë¶€=${EXTERNAL_TIME}s"
            
            # ì‹¤íŒ¨ íšŸìˆ˜ í™•ì¸
            if [ $FAILURE_COUNT -ge $MAX_FAILURES ]; then
              echo "âŒ ìµœëŒ€ ì‹¤íŒ¨ íšŸìˆ˜ ë„ë‹¬ ($FAILURE_COUNT/$MAX_FAILURES)"
              echo "ğŸš¨ ì„œë¹„ìŠ¤ ì¥ì•  ê°ì§€!"
              exit 1
            fi
            
            # ë‹¤ìŒ ì²´í¬ê¹Œì§€ ëŒ€ê¸°
            if [ $(date +%s) -lt $END_TIME ]; then
              echo "  â³ ë‹¤ìŒ ì²´í¬ê¹Œì§€ $HEALTH_CHECK_INTERVALì´ˆ ëŒ€ê¸°..."
              sleep $HEALTH_CHECK_INTERVAL
            fi
          done
          
          echo "ğŸ‰ í—¬ìŠ¤ì²´í¬ ì™„ë£Œ!"
          echo "ğŸ“Š ì²´í¬ íšŸìˆ˜: $CHECK_COUNT"
          echo "ğŸ“Š ì‹¤íŒ¨ íšŸìˆ˜: $FAILURE_COUNT"
          echo "ğŸ“Š ì„±ê³µë¥ : $(( (CHECK_COUNT * 3 - FAILURE_COUNT) * 100 / (CHECK_COUNT * 3) ))%"
        '

  # 3. ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ í™•ì¸
  database-check:
    runs-on: ubuntu-latest
    needs: check-environment
    if: needs.check-environment.outputs.current-env != 'none'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Check database status
      run: |
        echo "ğŸ’¾ ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ í™•ì¸ ì¤‘..."
        
        ssh -o StrictHostKeyChecking=no -i ${{ secrets.EC2_SSH_KEY }} ubuntu@${{ secrets.EC2_HOST }} '
          cd /home/ubuntu/showmethestock/backend
          
          # DB íŒŒì¼ ì¡´ì¬ í™•ì¸
          DB_FILES=("snapshots.db" "portfolio.db" "email_verifications.db" "news_data.db")
          
          echo "ğŸ“ ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ ìƒíƒœ:"
          for db_file in "${DB_FILES[@]}"; do
            if [ -f "$db_file" ]; then
              SIZE=$(du -h "$db_file" | cut -f1)
              echo "  âœ… $db_file: $SIZE"
            else
              echo "  âŒ $db_file: íŒŒì¼ ì—†ìŒ"
            fi
          done
          
          # DB ì—°ê²° í…ŒìŠ¤íŠ¸
          echo "ğŸ”— ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸:"
          if python3 -c "
import sqlite3
import sys

try:
    # snapshots.db ì—°ê²° í…ŒìŠ¤íŠ¸
    conn = sqlite3.connect(\"snapshots.db\")
    cursor = conn.cursor()
    cursor.execute(\"SELECT COUNT(*) FROM scan_rank\")
    count = cursor.fetchone()[0]
    conn.close()
    print(f\"âœ… snapshots.db: {count}ê°œ ë ˆì½”ë“œ\")
except Exception as e:
    print(f\"âŒ snapshots.db: {e}\")
    sys.exit(1)

try:
    # portfolio.db ì—°ê²° í…ŒìŠ¤íŠ¸
    conn = sqlite3.connect(\"portfolio.db\")
    cursor = conn.cursor()
    cursor.execute(\"SELECT COUNT(*) FROM portfolio\")
    count = cursor.fetchone()[0]
    conn.close()
    print(f\"âœ… portfolio.db: {count}ê°œ ë ˆì½”ë“œ\")
except Exception as e:
    print(f\"âŒ portfolio.db: {e}\")

try:
    # email_verifications.db ì—°ê²° í…ŒìŠ¤íŠ¸
    conn = sqlite3.connect(\"email_verifications.db\")
    cursor = conn.cursor()
    cursor.execute(\"SELECT COUNT(*) FROM email_verifications\")
    count = cursor.fetchone()[0]
    conn.close()
    print(f\"âœ… email_verifications.db: {count}ê°œ ë ˆì½”ë“œ\")
except Exception as e:
    print(f\"âŒ email_verifications.db: {e}\")

try:
    # news_data.db ì—°ê²° í…ŒìŠ¤íŠ¸
    conn = sqlite3.connect(\"news_data.db\")
    cursor = conn.cursor()
    cursor.execute(\"SELECT COUNT(*) FROM news_data\")
    count = cursor.fetchone()[0]
    conn.close()
    print(f\"âœ… news_data.db: {count}ê°œ ë ˆì½”ë“œ\")
except Exception as e:
    print(f\"âŒ news_data.db: {e}\")
" 2>/dev/null; then
            echo "ğŸ‰ ëª¨ë“  ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ìƒ"
          else
            echo "âŒ ì¼ë¶€ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨"
            exit 1
          fi
        '

  # 4. ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ í™•ì¸
  system-resources:
    runs-on: ubuntu-latest
    needs: check-environment
    if: needs.check-environment.outputs.current-env != 'none'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Check system resources
      run: |
        echo "ğŸ’» ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ í™•ì¸ ì¤‘..."
        
        ssh -o StrictHostKeyChecking=no -i ${{ secrets.EC2_SSH_KEY }} ubuntu@${{ secrets.EC2_HOST }} '
          echo "ğŸ–¥ï¸ ì‹œìŠ¤í…œ ì •ë³´:"
          
          # CPU ì‚¬ìš©ë¥ 
          CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk "{print \$2}" | awk -F"%" "{print \$1}")
          echo "  ğŸ’¾ CPU ì‚¬ìš©ë¥ : ${CPU_USAGE}%"
          
          # ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ 
          MEMORY_INFO=$(free | grep Mem)
          MEMORY_TOTAL=$(echo $MEMORY_INFO | awk "{print \$2}")
          MEMORY_USED=$(echo $MEMORY_INFO | awk "{print \$3}")
          MEMORY_USAGE=$((MEMORY_USED * 100 / MEMORY_TOTAL))
          echo "  ğŸ§  ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ : ${MEMORY_USAGE}%"
          
          # ë””ìŠ¤í¬ ì‚¬ìš©ë¥ 
          DISK_USAGE=$(df /home/ubuntu | tail -1 | awk "{print \$5}" | sed "s/%//")
          echo "  ğŸ’½ ë””ìŠ¤í¬ ì‚¬ìš©ë¥ : ${DISK_USAGE}%"
          
          # ë¡œë“œ í‰ê· 
          LOAD_AVG=$(uptime | awk -F"load average:" "{print \$2}" | awk "{print \$1}" | sed "s/,//")
          echo "  âš–ï¸ ë¡œë“œ í‰ê· : $LOAD_AVG"
          
          # ì„œë¹„ìŠ¤ ìƒíƒœ
          echo "ğŸ”§ ì„œë¹„ìŠ¤ ìƒíƒœ:"
          CURRENT_ENV="${{ needs.check-environment.outputs.current-env }}"
          
          if sudo systemctl is-active --quiet stock-finder-backend-$CURRENT_ENV; then
            echo "  âœ… ë°±ì—”ë“œ ì„œë¹„ìŠ¤: ì‹¤í–‰ ì¤‘"
          else
            echo "  âŒ ë°±ì—”ë“œ ì„œë¹„ìŠ¤: ì¤‘ì§€ë¨"
          fi
          
          if sudo systemctl is-active --quiet stock-finder-frontend-$CURRENT_ENV; then
            echo "  âœ… í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤: ì‹¤í–‰ ì¤‘"
          else
            echo "  âŒ í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤: ì¤‘ì§€ë¨"
          fi
          
          if sudo systemctl is-active --quiet nginx; then
            echo "  âœ… Nginx: ì‹¤í–‰ ì¤‘"
          else
            echo "  âŒ Nginx: ì¤‘ì§€ë¨"
          fi
          
          # ê²½ê³  ì²´í¬
          WARNINGS=0
          
          if [ $CPU_USAGE -gt 80 ]; then
            echo "  âš ï¸ ê²½ê³ : CPU ì‚¬ìš©ë¥ ì´ ë†’ìŠµë‹ˆë‹¤ (${CPU_USAGE}%)"
            WARNINGS=$((WARNINGS + 1))
          fi
          
          if [ $MEMORY_USAGE -gt 80 ]; then
            echo "  âš ï¸ ê²½ê³ : ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ ì´ ë†’ìŠµë‹ˆë‹¤ (${MEMORY_USAGE}%)"
            WARNINGS=$((WARNINGS + 1))
          fi
          
          if [ $DISK_USAGE -gt 80 ]; then
            echo "  âš ï¸ ê²½ê³ : ë””ìŠ¤í¬ ì‚¬ìš©ë¥ ì´ ë†’ìŠµë‹ˆë‹¤ (${DISK_USAGE}%)"
            WARNINGS=$((WARNINGS + 1))
          fi
          
          if [ $WARNINGS -eq 0 ]; then
            echo "ğŸ‰ ëª¨ë“  ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ì •ìƒ"
          else
            echo "âš ï¸ $WARNINGSê°œì˜ ê²½ê³ ê°€ ìˆìŠµë‹ˆë‹¤"
          fi
        '

  # 5. ëª¨ë‹ˆí„°ë§ ê²°ê³¼ ìš”ì•½
  monitoring-summary:
    runs-on: ubuntu-latest
    needs: [check-environment, health-check, database-check, system-resources]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Generate monitoring summary
      run: |
        echo "ğŸ“Š ëª¨ë‹ˆí„°ë§ ê²°ê³¼ ìš”ì•½"
        echo "========================"
        
        CURRENT_ENV="${{ needs.check-environment.outputs.current-env }}"
        HEALTH_STATUS="${{ needs.health-check.result }}"
        DATABASE_STATUS="${{ needs.database-check.result }}"
        SYSTEM_STATUS="${{ needs.system-resources.result }}"
        
        echo "ğŸ“ í˜„ì¬ í™˜ê²½: $CURRENT_ENV"
        echo "ğŸ¥ í—¬ìŠ¤ì²´í¬: $HEALTH_STATUS"
        echo "ğŸ’¾ ë°ì´í„°ë² ì´ìŠ¤: $DATABASE_STATUS"
        echo "ğŸ’» ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤: $SYSTEM_STATUS"
        
        # ì „ì²´ ìƒíƒœ ê³„ì‚°
        if [ "$HEALTH_STATUS" = "success" ] && [ "$DATABASE_STATUS" = "success" ] && [ "$SYSTEM_STATUS" = "success" ]; then
          OVERALL_STATUS="success"
          echo "ğŸ‰ ì „ì²´ ì‹œìŠ¤í…œ ìƒíƒœ: ì •ìƒ"
        else
          OVERALL_STATUS="failure"
          echo "âŒ ì „ì²´ ì‹œìŠ¤í…œ ìƒíƒœ: ë¬¸ì œ ìˆìŒ"
        fi
        
        # ëª¨ë‹ˆí„°ë§ ì •ë³´ ì €ì¥
        echo "{
          \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
          \"environment\": \"$CURRENT_ENV\",
          \"overall_status\": \"$OVERALL_STATUS\",
          \"health_check\": \"$HEALTH_STATUS\",
          \"database_check\": \"$DATABASE_STATUS\",
          \"system_resources\": \"$SYSTEM_STATUS\",
          \"github_workflow\": \"${{ github.workflow }}\",
          \"github_run_id\": \"${{ github.run_id }}\"
        }" > monitoring-summary.json
        
        echo "ğŸ“„ ëª¨ë‹ˆí„°ë§ ìš”ì•½ì´ monitoring-summary.jsonì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."
        
        # ìƒíƒœì— ë”°ë¥¸ ì¢…ë£Œ ì½”ë“œ
        if [ "$OVERALL_STATUS" = "failure" ]; then
          exit 1
        fi
