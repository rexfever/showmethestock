name: Deploy to EC2

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨
          cd /home/ubuntu/showmethestock
          echo "ğŸ”„ ì½”ë“œ ì—…ë°ì´íŠ¸ ì¤‘..."
          
          # ë¡œì»¬ ë³€ê²½ì‚¬í•­ ë¬´ì‹œí•˜ê³  ê°•ì œ ë™ê¸°í™” (ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ì€ .gitignoreë¡œ ë³´í˜¸ë¨)
          git fetch origin
          git reset --hard origin/main
          
          echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
          # í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
          cd frontend
          npm ci --production=false
          
          echo "ğŸ”¨ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì¤‘..."
          # ì´ì „ ë¹Œë“œ ìºì‹œ ì œê±°
          rm -rf .next
          npm run build
          
          # ë°±ì—”ë“œë¡œ ì´ë™
          cd ../backend
          echo "ğŸ ë°±ì—”ë“œ ì˜ì¡´ì„± í™•ì¸ ì¤‘..."
          pip install -r requirements.txt --quiet
          
          echo "ğŸ”§ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘..."
          # ë°±ì—”ë“œ ë¨¼ì € ì¬ì‹œì‘
          sudo systemctl restart stock-finder-backend
          sleep 5
          
          # í”„ë¡ íŠ¸ì—”ë“œ ì¬ì‹œì‘
          sudo systemctl restart stock-finder-frontend
          sleep 10
          
          echo "ğŸ” ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ì¤‘..."
          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          if ! sudo systemctl is-active --quiet stock-finder-backend; then
            echo "âŒ ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì‹œì‘ ì‹¤íŒ¨"
            sudo systemctl status stock-finder-backend --no-pager -l
            exit 1
          fi
          
          if ! sudo systemctl is-active --quiet stock-finder-frontend; then
            echo "âŒ í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ ì‹œì‘ ì‹¤íŒ¨"
            sudo systemctl status stock-finder-frontend --no-pager -l
            exit 1
          fi
          
          echo "ğŸŒ í—¬ìŠ¤ ì²´í¬ ì¤‘..."
          # í—¬ìŠ¤ ì²´í¬ (ìµœëŒ€ 3íšŒ ì‹œë„)
          for i in {1..3}; do
            if curl -f -s http://localhost:8010/health > /dev/null; then
              echo "âœ… ë°±ì—”ë“œ í—¬ìŠ¤ ì²´í¬ ì„±ê³µ"
              break
            elif [ $i -eq 3 ]; then
              echo "âŒ ë°±ì—”ë“œ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨"
              exit 1
            else
              echo "â³ ë°±ì—”ë“œ í—¬ìŠ¤ ì²´í¬ ì¬ì‹œë„ ì¤‘... ($i/3)"
              sleep 5
            fi
          done
          
          for i in {1..3}; do
            if curl -f -s http://localhost:3000/admin > /dev/null; then
              echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ ì²´í¬ ì„±ê³µ"
              break
            elif [ $i -eq 3 ]; then
              echo "âŒ í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨"
              exit 1
            else
              echo "â³ í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ ì²´í¬ ì¬ì‹œë„ ì¤‘... ($i/3)"
              sleep 5
            fi
          done
          
          echo "âœ… ë°°í¬ ì™„ë£Œ!"
          echo "ğŸ“Š ìµœì¢… ì„œë¹„ìŠ¤ ìƒíƒœ:"
          sudo systemctl status stock-finder-backend --no-pager -l | head -3
          sudo systemctl status stock-finder-frontend --no-pager -l | head -3
